# 多资产支持更新 - 做多/做空功能

## 更新日期: 2025-10-23

## 概述

基于用户反馈，完善了多资产交易支持，特别是期货和期权的做空功能。

## 新增功能

### 1. 持仓方向选择 ✅

在"手动输入记录"表单中新增**持仓方向**选择：

- **做多 (Long)**: 买入看涨，价格上涨盈利
- **做空 (Short)**: 卖空看跌，价格下跌盈利

**适用场景**:
- 股票/ETF: 通常只能做多
- 期货: 可以做多或做空
- 期权: 可以做多或做空

### 2. 保证金输入 ✅

当选择**期货**或**期权**时，自动显示"保证金"输入框：

- 用于记录期货/期权合约使用的保证金
- 股票/ETF 自动设置为 0
- 帮助追踪杠杆使用情况

### 3. 智能盈亏计算 ✅

系统根据持仓方向自动计算盈亏：

#### 做多（Long）
```
盈亏 = 卖出金额 - 买入金额
盈亏 = (卖出价格 - 买入价格) × 数量

例子：买入 100 股 @ ¥10，卖出 @ ¥12
盈亏 = (12 - 10) × 100 = ¥200 ✅ 盈利
```

#### 做空（Short）
```
盈亏 = 买入金额 - 卖出金额
盈亏 = (买入价格 - 卖出价格) × 数量

例子：做空 100 股 @ ¥10，平仓 @ ¥8
盈亏 = (10 - 8) × 100 = ¥200 ✅ 盈利
```

### 4. 改进的显示界面 ✅

#### 开仓/平仓下拉框
显示格式: `代码 [资产类型] 方向 - 日期 (数量@价格)`

示例:
- `600519.SH [stock] 做多 - 2024-01-15 (100@¥150.00)`
- `IF2401 [futures] 做空 - 2024-01-10 (1@¥4500.00)`

#### 投资记录表格
新增列并重新排序：
```
代码 | 资产类型 | 方向 | 买入日期 | 买入价格 | 数量 | 买入金额 |
保证金 | 卖出日期 | 卖出价格 | 盈亏 | 数据来源
```

## 使用示例

### 场景 1: 股票做多

```
资产类型: 股票
代码: 600519.SH
方向: 做多 (Long)
买入价格: ¥150.00
数量: 100
保证金: 0 (自动)

→ 买入金额: ¥15,000

平仓价格: ¥165.00
→ 盈亏: ¥1,500 (+10%)
```

### 场景 2: 期货做空

```
资产类型: 期货
代码: IF2401
方向: 做空 (Short)
买入价格: ¥4,500
数量: 1
保证金: ¥5,000 (手动输入)

→ 买入金额: ¥4,500

平仓价格: ¥4,300
→ 盈亏: ¥200 (+4.44%)
  (做空时价格下跌盈利)
```

### 场景 3: 期权做多

```
资产类型: 期权
代码: 510050C2401M04000
方向: 做多 (Long)
买入价格: ¥0.15
数量: 10
保证金: ¥150

→ 买入金额: ¥1.50

平仓价格: ¥0.25
→ 盈亏: ¥1.00 (+66.67%)
```

## 技术实现

### 数据模型 (models.py)

```python
class InvestmentRecord(Base):
    # ... 其他字段 ...

    # Multi-asset support (v0.3)
    direction: Mapped[str] = mapped_column(
        String(10),
        nullable=False,
        default="long",
        server_default="long"
    )
    margin_used: Mapped[float] = mapped_column(
        Float,
        nullable=False,
        default=0.0,
        server_default="0.0"
    )
```

### 盈亏计算逻辑

```python
# Calculate profit/loss based on direction
sale_amount = sale_price * quantity

if direction == "long":
    # 做多: 卖出价 > 买入价 = 盈利
    profit_loss = sale_amount - purchase_amount
else:  # short
    # 做空: 买入价 > 卖出价 = 盈利
    profit_loss = purchase_amount - sale_amount
```

## UI 改进

### 买入表单布局

```
┌─────────────────────────────────────────┐
│ 资产类型: [下拉选择]                     │
├─────────────────────────────────────────┤
│ 代码: [文本输入]                         │
├──────────────────┬──────────────────────┤
│ 方向: [做多/做空] │ 买入日期: [日期选择] │
├──────────────────┼──────────────────────┤
│ 买入价格: [数字]  │ 数量: [数字]         │
├─────────────────────────────────────────┤
│ 保证金: [数字] (仅期货/期权显示)        │
└─────────────────────────────────────────┘
```

### 平仓确认信息

```
✅ 平仓记录已保存！

- 资产: IF2401
- 方向: 做空
- 开仓: ¥4,500.00
- 平仓: ¥4,300.00
- 盈亏: ¥200.00 (+4.44%)
```

## 注意事项

### 1. 做空的理解

**做空流程**:
1. 开仓时以高价"卖出"（实际是借入后卖出）
2. 平仓时以低价"买回"（归还）
3. 差价即为利润

**盈亏逻辑**:
- 价格下跌 → 盈利 ✅
- 价格上涨 → 亏损 ❌

### 2. 保证金管理

- 保证金仅用于记录，不影响盈亏计算
- 期货一般需要 10-15% 保证金
- 期权保证金根据合约而定
- 股票无需保证金（全额支付）

### 3. 数据迁移

现有记录会自动设置：
- `direction = "long"` (默认做多)
- `margin_used = 0.0` (无保证金)

## 未来改进

### 短期
- [ ] 添加持仓成本价调整（加仓/减仓）
- [ ] 支持期权行权记录
- [ ] 添加期货交割记录

### 中期
- [ ] 保证金使用率监控
- [ ] 做空风险提示
- [ ] 融资融券利息计算

### 长期
- [ ] 对冲组合分析
- [ ] 期现套利策略
- [ ] Greeks 值追踪（期权）

## 相关文件

- `investlib-data/investlib_data/models.py` - 数据模型
- `investapp/investapp/pages/2_投资记录_Records.py` - 记录管理页面
- `investlib-data/alembic/versions/f85281706898_extend_tables_for_multi_asset.py` - 数据库迁移

## 测试案例

### 测试 1: 股票做多
```python
开仓: 600519.SH, 做多, 100股@¥150
平仓: ¥165
预期: 盈利 ¥1,500 (+10%)
```

### 测试 2: 期货做空
```python
开仓: IF2401, 做空, 1手@¥4500, 保证金¥5000
平仓: ¥4300
预期: 盈利 ¥200 (+4.44%)
```

### 测试 3: 期货做多
```python
开仓: IF2401, 做多, 1手@¥4300
平仓: ¥4500
预期: 盈利 ¥200 (+4.65%)
```

### 测试 4: 期货做空亏损
```python
开仓: IF2401, 做空, 1手@¥4300
平仓: ¥4500
预期: 亏损 -¥200 (-4.65%)
```

## 版本信息

- MyInvest 版本: v0.3 (开发中)
- 更新模块: 投资记录管理
- 支持资产: 股票、ETF、期货、期权、债券等

## 反馈

如有问题或建议，请：
1. 检查 `verify_schema.py` 确保数据库一致
2. 查看 Streamlit 错误日志
3. 参考 `MODEL_UPDATE_SUMMARY.md` 了解技术细节
