# MyInvest V0.3 - Production-Ready Enhancement 规划提案

**版本**: V0.3
**主题**: Production-Ready Enhancement (生产就绪增强)
**创建日期**: 2025-10-22
**状态**: 📝 提案阶段
**依赖**: V0.2 完整完成

---

## 🎯 V0.3 目标

基于 V0.2 的多策略回测与自动化系统,V0.3 聚焦在**提升生产可用性**、**品种扩展**和**用户体验优化**:

1. **解决运营痛点** - 监视列表硬编码、回测性能慢
2. **扩展交易品种** - 支持期货(股指/商品)和期权(股票/ETF期权) ⭐ 新增
3. **增强决策支持** - 参数优化、风险监控(含保证金/强平)、报告导出
4. **提升便利性** - 批量操作、智能诊断、跨品种回测

**不在V0.3范围**:
- ❌ 真实券商API集成(推迟到V0.4)
- ❌ 实盘交易模式(推迟到V0.4)
- ❌ 推送通知系统(推迟到V0.4) 🔄 调整
- ❌ 多用户/权限系统(推迟到V0.5)
- ❌ 分钟级/Tick数据(推迟到V0.5)

---

## 📦 User Stories

### US11 (P0): 监视列表管理 - Watchlist Management

**优先级**: P0 - BLOCKING (当前硬编码严重影响使用)

**用户场景**:
作为投资者,我想通过UI界面管理监视列表,以便灵活调整跟踪的股票池,而不是修改代码。

**核心需求**:
1. UI添加/删除股票到监视列表
2. 分组管理:
   - 核心持仓 (Core Holdings)
   - 观察池 (Watchlist)
   - 行业板块 (Sector Groups)
3. 自动同步到调度器
4. 支持批量导入(CSV)
5. 显示每只股票的状态(活跃/暂停)

**验收标准**:
- [ ] 可通过UI添加股票 600519.SH 到监视列表
- [ ] 调度器自动获取最新监视列表(不需要重启)
- [ ] 可将股票分组到"核心持仓"并仅为此组生成推荐
- [ ] 批量导入10只股票CSV成功
- [ ] 暂停某股票后,调度器跳过该股票

**技术任务 (T101-T110)**:
- T101: 数据库表 `watchlist` schema设计
- T102: CRUD API实现 (`watchlist_db.py`)
- T103: UI页面 `9_watchlist.py`
- T104: 分组管理逻辑
- T105: 调度器集成(动态加载)
- T106: CSV批量导入
- T107: 股票状态管理(active/paused)
- T108: 测试: 添加/删除/分组
- T109: 测试: 调度器动态加载
- T110: 文档更新

**工期估算**: 2-3天

---

### US12 (P0): 回测并行化 - Parallel Backtesting

**优先级**: P0 - CRITICAL PERFORMANCE (当前10股票需10+分钟)

**用户场景**:
作为投资者,我想同时回测多只股票,以便快速评估整个投资组合的策略表现,而不是等待漫长的串行执行。

**核心需求**:
1. 使用 ProcessPoolExecutor 并行回测
2. 实时进度条(处理中股票/总股票)
3. 批量回测报告汇总
4. 错误隔离(单股票失败不影响其他)
5. CPU核心数自动检测(max_workers)

**验收标准**:
- [ ] 回测10只股票时间 < 3分钟(vs 当前10+分钟)
- [ ] 进度条实时更新"3/10股票已完成"
- [ ] 单股票失败不中断整体回测
- [ ] 批量报告显示所有股票的Sharpe/Drawdown对比表
- [ ] 自动使用8核CPU并行(如果可用)

**技术任务 (T111-T118)**:
- T111: 重构 `BacktestRunner` 支持单股票独立运行
- T112: 实现 `ParallelBacktestRunner` (ProcessPoolExecutor)
- T113: 进度跟踪机制(Queue/Manager)
- T114: 错误处理和重试逻辑
- T115: 批量报告生成器
- T116: UI实时进度条更新
- T117: 测试: 10股票并行 vs 串行性能对比
- T118: CPU核心数配置

**工期估算**: 3-4天

---

### US13 (P1): 策略参数优化器 - Parameter Optimizer

**优先级**: P1 - CORE ENHANCEMENT

**用户场景**:
作为策略开发者,我想自动搜索最优参数组合,以便找到最佳的止损/止盈/仓位配置,而不是依赖经验猜测。

**核心需求**:
1. 网格搜索(Grid Search)
   - 止损范围: 2%-5%, 步长0.5%
   - 止盈范围: 3%-10%, 步长1%
   - 仓位范围: 8%-20%, 步长2%
2. Walk-Forward验证
   - 训练期: 2年
   - 测试期: 1年
   - 滚动窗口验证
3. 参数热力图可视化
   - X轴止损, Y轴止盈, 颜色Sharpe
4. 最优参数推荐
5. 过拟合检测(训练vs测试Sharpe差异)

**验收标准**:
- [ ] 网格搜索7×8×7=392组参数组合
- [ ] 显示热力图: Sharpe最高的参数在(止损3%, 止盈6%)
- [ ] Walk-Forward验证显示训练Sharpe=1.8, 测试Sharpe=1.5(健康)
- [ ] 警告过拟合: "训练Sharpe 2.5, 测试Sharpe 0.8, 可能过拟合"
- [ ] 保存最优参数到策略配置

**技术任务 (T119-T128)**:
- T119: 网格搜索引擎 (`parameter_optimizer.py`)
- T120: Walk-Forward验证逻辑
- T121: 参数空间定义(止损/止盈/仓位范围)
- T122: 热力图生成(Plotly heatmap)
- T123: 过拟合检测算法
- T124: 最优参数推荐逻辑
- T125: UI页面 `10_parameter_optimizer.py`
- T126: 并行优化(复用US12的并行引擎)
- T127: 测试: Kroll策略参数优化
- T128: 文档: 参数优化最佳实践

**工期估算**: 4-5天

---

### US14 (P1): 报告导出系统 - Report Export

**优先级**: P1 - USER EXPERIENCE

**用户场景**:
作为投资者,我想导出回测报告PDF和交易记录Excel,以便离线查看、打印或分享给投资顾问。

**核心需求**:
1. **回测报告PDF**
   - 封面: 策略名称、回测期间、生成日期
   - 第1页: 性能指标表格
   - 第2页: 权益曲线图
   - 第3页: 回撤分析图
   - 第4页: 交易历史表格(前50笔)
   - 页脚: 免责声明

2. **交易记录Excel**
   - Sheet1: 交易明细(买入/卖出/盈亏)
   - Sheet2: 月度汇总
   - Sheet3: 持仓分析
   - 格式化: 颜色标记盈利/亏损

3. **持仓报表Word**
   - 当前持仓表格
   - 风险指标(VaR, 集中度)
   - 建议操作

**验收标准**:
- [ ] 点击"导出PDF"生成 `backtest_report_600519_20251022.pdf`
- [ ] PDF包含所有图表(权益曲线、回撤图)和表格
- [ ] Excel有3个工作表,盈利行标绿色,亏损行标红色
- [ ] Word报表包含当前持仓和风险指标
- [ ] 所有报告包含"本报告仅供参考,不构成投资建议"免责声明

**技术任务 (T129-T138)**:
- T129: PDF生成器 (`reportlab` 或 `weasyprint`)
- T130: PDF模板设计(封面/章节)
- T131: Excel生成器 (`openpyxl`)
- T132: Excel样式和格式化
- T133: Word生成器 (`python-docx`)
- T134: 报告数据准备器(从数据库提取)
- T135: UI导出按钮集成
- T136: 测试: 生成各类报告
- T137: 样式优化(公司Logo, 颜色主题)
- T138: 文档: 报告模板定制指南

**工期估算**: 3-4天

---

### US15 (P1): 期货与期权品种支持 - Futures & Options Support

**优先级**: P1 - PRODUCT EXPANSION

**用户场景**:
作为投资者,我想在系统中交易期货(商品期货、股指期货)和期权(股票期权、ETF期权),以便实现多品种资产配置和对冲策略,而不仅限于股票交易。

**⚠️ 重要设计原则: 品种隔离与策略分离**

期货/期权与股票交易机制存在本质差异,必须在架构层面分离设计:

| 维度 | 股票 | 期货 | 期权 |
|------|------|------|------|
| 交易方向 | 单向(做多) | 双向(多空) | 双向+复杂组合 |
| 资金占用 | 全额(T+1) | 保证金(T+0) | 权利金+保证金 |
| 强平风险 | 无 | **有(保证金不足)** | 卖方有 |
| 到期处理 | 无 | 移仓换月 | **自动行权/作废** |
| 盈亏计算 | 价差×股数 | 价差×乘数×手数 | 非线性(含时间价值) |
| 风险指标 | 仓位、波动率 | 杠杆率、强平距离 | 希腊值、隐含波动率 |
| **数据来源** | **efinance (现有)** | **efinance (扩展)** | **efinance (扩展)** |

**设计要求**:
1. ✅ **策略基类分离**: `StockStrategy` / `FuturesStrategy` / `OptionsStrategy`
2. ✅ **回测引擎分离**: 不同品种使用不同的 `BacktestEngine` 实现
3. ✅ **资金管理分离**: 股票全额制 vs 期货保证金制
4. ✅ **信号生成分离**: 期货需考虑持仓方向(多/空)
5. ✅ **风险计算分离**: 期权需计算希腊值和隐含波动率
6. ✅ **数据接口分离**: 不同品种使用独立的数据适配器 ⭐ 新增

**⚠️ 数据集成设计 - efinance 主数据源 + AkShare 统一备份**

系统已使用 **efinance** 作为股票数据源,现扩展支持期货和期权,**所有品种统一使用双数据源备份**:

| 数据维度 | 股票 | 期货 | 期权 |
|---------|------|------|------|
| **主数据源** | efinance (现有) | efinance | efinance |
| **备用数据源** | **AkShare** ⭐ | **AkShare** ⭐ | **AkShare** ⭐ |
| **历史数据** | 10年+ ✅ | 支持主力合约/连续合约 | 支持(需验证可用性) |
| **实时行情** | 支持 ✅ | 支持 | 支持 |
| **合约信息** | 简单(代码+名称) | **复杂**(主力合约、连续合约、交割日) | **极复杂**(行权价、希腊值需计算) |
| **数据质量** | 高(已验证) | 需测试(主力合约切换) | 需测试(流动性差,可能缺失) |
| **字段差异** | open/high/low/close/volume | **结算价、持仓量** | **需自行计算希腊值** |

**数据集成策略**:
1. **主数据源**: 优先使用 efinance (股票/期货/期权统一)
2. **统一备份**: efinance 获取失败时,自动降级到 AkShare (所有品种) ⭐
3. **适配器模式**: `StockDataAdapter` / `FuturesDataAdapter` / `OptionsDataAdapter`
4. **统一接口**: 所有适配器实现 `get_bars()`, `get_latest_price()` 等标准方法
5. **数据缓存**: 期货/期权数据获取慢,必须本地缓存(复用现有缓存机制)
6. **数据验证**: 期权数据易缺失,需要数据完整性检查
7. **希腊值计算**: 期权希腊值使用 Black-Scholes 模型本地计算

**统一降级策略** (所有品种):
```python
# 统一数据获取流程 (股票/期货/期权)
try:
    # 优先 efinance
    data = efinance.get_data(symbol, asset_type)
except Exception as e:
    logger.warning(f"{asset_type} {symbol}: efinance失败, 降级到AkShare")
    # 自动降级到 AkShare
    data = akshare.get_data(symbol, asset_type)
```

**优势**:
- ✅ 主数据源统一 (efinance),降低维护成本
- ✅ **所有品种都有备份** (AkShare),全面提高健壮性 ⭐
- ✅ 统一降级策略,代码简洁
- ✅ 无需 Tushare 积分、CTP 账户等复杂配置
- ✅ 复用现有的数据缓存和验证逻辑
- ✅ 自动降级,对业务层透明

**核心需求**:
1. **品种类型扩展**
   - 股票 (现有)
   - 商品期货 (IF、IC、IH、IM等股指期货; CU、AU等商品期货)
   - 股票期权 (50ETF期权、300ETF期权、个股期权)
   - 期货期权

2. **数据结构调整**
   - 合约代码规范 (IF2506.CFFEX, 10005321.SHSE等)
   - 合约信息表: 合约乘数、最小变动价位、到期日、交割方式
   - 保证金率配置
   - 期权希腊值存储 (Delta, Gamma, Vega, Theta)

3. **交易规则适配**
   - T+0交易 (期货/期权)
   - 双向交易 (做多/做空)
   - 保证金计算
   - 涨跌停板限制
   - 强平逻辑

4. **策略兼容性**
   - 现有策略支持期货/期权
   - 期货特有策略: 跨期套利、跨品种套利
   - 期权策略: 备兑开仓、保护性看跌、跨式组合

5. **回测引擎增强**
   - 保证金占用计算
   - 强平模拟
   - 期权到期自动行权/作废
   - **期权提前行权** (美式期权) ⭐ 新增
   - 期货移仓换月

**⚠️ 期权复杂性说明**:
- **欧式期权** (50ETF期权): 仅到期日行权 (相对简单)
- **美式期权** (部分个股期权): 可提前行权 (复杂度高)
- **V0.3策略**: 优先支持欧式期权，美式期权简化处理（仅到期行权）
- **未来增强** (V0.4): 增加美式期权提前行权的最优策略模拟

**验收标准**:

**数据集成验收** (优先级最高):
- [ ] efinance 成功获取股票历史数据(600519.SH)
- [ ] efinance 成功获取期货主力合约历史数据(IF2506.CFFEX)
- [ ] efinance 成功获取期权历史数据(含行权价、到期日)
- [ ] **统一降级策略**: efinance 获取失败时,所有品种自动降级到 AkShare ⭐
  - 股票降级: efinance → AkShare
  - 期货降级: efinance → AkShare
  - 期权降级: efinance → AkShare
- [ ] 降级过程对业务层透明,无感知
- [ ] 期货主力合约切换时,数据连续无断点
- [ ] 期权数据缺失时,系统提示并跳过该期权
- [ ] 数据缓存生效,第二次获取同一合约速度<1秒
- [ ] 期权希腊值计算正确(Black-Scholes模型)

**功能验收**:
- [ ] 可添加期货合约 IF2506.CFFEX 到监视列表
- [ ] 回测期货策略,正确计算保证金占用和强平
- [ ] 支持做空开仓,回测显示空头盈亏
- [ ] 期权回测包含希腊值计算和到期处理
- [ ] 监视列表显示"品种类型: 期货/期权/股票"标签
- [ ] 风险监控显示"保证金占用率: 65%"

**技术任务 (T139-T170)**:

**阶段1: 数据集成与基础设施 (T139-T146)** ⭐ 关键
- T139: 数据库schema扩展 (`contract_info` 表)
- T140: 合约代码解析器 (识别品种类型: stock/future/option)
- T141: **中心化配置管理模块** (`config/settings.py`) ⭐ 新增
  - 使用 Pydantic BaseSettings 实现类型安全
  - 配置分组: DataSourceSettings, FuturesSettings, OptionsSettings, RiskSettings
  - 自定义 validator (如强平线<保证金率)
  - 支持嵌套结构 (env_nested_delimiter='__')
  - 单元测试: 配置校验逻辑
- T142: **扩展现有 efinance 数据层**
  - 验证 efinance 股票/期货/期权数据获取能力
  - 验证 AkShare 股票/期货/期权数据获取能力
  - 测试主力合约、连续合约支持
- T143: **股票数据适配器增强** (`StockDataAdapter`) ⭐
  - 主数据源: efinance (现有)
  - 备份数据源: AkShare (新增)
  - 自动降级逻辑
  - 使用 settings.data_source 配置
- T144: **期货数据适配器** (`FuturesDataAdapter`)
  - 主数据源: efinance
  - 备份数据源: AkShare
  - 自动降级逻辑
  - 主力合约切换处理
  - 使用 settings.futures 配置
- T145: **期权数据适配器** (`OptionsDataAdapter`)
  - 主数据源: efinance
  - 备份数据源: AkShare
  - 自动降级逻辑
  - 希腊值计算 (Black-Scholes)
  - 使用 settings.options 配置
- T146: **.env 配置文件重构** (嵌套结构,双下划线分隔符)

**阶段2: 策略基类分离设计 (T147-T151)** ⭐ 核心
- T147: 重构 `BaseStrategy` 为抽象基类
- T148: 实现 `StockStrategy` (保留现有逻辑)
- T149: 实现 `FuturesStrategy` (支持双向持仓、保证金计算)
- T150: 实现 `OptionsStrategy` (支持多腿组合、希腊值监控)
- T151: 策略工厂模式 (根据品种类型自动选择策略类)

**阶段3: 回测引擎分离设计 (T152-T156)** ⭐ 核心
- T152: 重构 `BacktestEngine` 为抽象基类
- T153: 实现 `StockBacktestEngine` (T+1全额制)
- T154: 实现 `FuturesBacktestEngine` (T+0保证金制、强平逻辑)
- T155: 实现 `OptionsBacktestEngine` (到期处理、行权逻辑)
- T156: 统一回测调度器 (支持多品种混合回测)

**阶段4: 交易规则与风险管理 (T157-T162)**
- T157: 期货保证金计算引擎 (逐日盯市,使用 settings.futures)
- T158: 强平检测和执行逻辑
- T159: 期权到期处理 (自动行权/作废/现金结算)
- T160: **美式期权提前行权调研** ⭐ 新增
  - 调研提前行权对回测影响
  - 设计简化策略(V0.3仅到期行权)
  - 评估V0.4完整支持的复杂度
- T161: 期货移仓换月策略 (主力合约切换)
- T162: 双向持仓管理 (多头仓位、空头仓位分离)

**阶段5: UI与报告 (T163-T165)**
- T163: UI品种类型选择器 (股票/期货/期权分页)
- T164: 回测报告增强 (保证金曲线、强平记录、希腊值曲线)
- T165: 风险监控适配 (保证金占用率、强平距离)

**阶段6: 测试与验证 (T166-T174)** ⭐ 关键
- T166: 测试: 配置管理模块(类型校验、validator) ⭐ 新增
- T167: 测试: efinance 所有品种数据获取
- T168: 测试: 统一降级策略 (股票/期货/期权 efinance→AkShare) ⭐
- T169: 测试: 期货主力合约切换数据连续性
- T170: 测试: 期权数据缺失处理 + 希腊值计算
- T171: 测试: 美式期权简化处理(仅到期行权) ⭐
- T172: 测试: 期货回测完整流程 (开多/开空/移仓)
- T173: 测试: 期权策略回测 (备兑开仓、保护性看跌)
- T174: 测试: 跨品种组合回测 (股票+期货对冲)
- T175: 文档: 配置管理指南 + 期货/期权交易规则 + 美式期权说明

**工期估算**: 7-8天 (增加配置管理模块和期权复杂性调研)

---

### US16 (P1): 风险监控仪表盘 - Risk Dashboard

**优先级**: P1 - RISK MANAGEMENT

**用户场景**:
作为投资者,我想实时查看持仓风险指标(包括股票、期货、期权),以便主动管理集中度风险、保证金风险和市场风险,避免黑天鹅事件和强平风险。

**核心需求**:
1. **持仓热力图**
   - 气泡大小: 仓位占比/保证金占用
   - 颜色: 盈亏比例(绿盈红亏)
   - 标签: 代码 + 品种类型标识(股/期/权)

2. **风险指标**
   - VaR (95%置信度, 1日风险价值)
   - CVaR (条件风险价值)
   - 最大单一持仓占比
   - 行业/品种集中度
   - **保证金占用率** (期货/期权专用)
   - **强平风险评估** (距离强平线的安全边际)

3. **止损/强平预警**
   - 股票: 距离止损价的百分比
   - 期货: 距离强平价的百分比
   - 期权: 时间价值衰减预警
   - 预警级别: 距离<2% 红色, 2-5% 黄色

4. **相关性分析**
   - 持仓标的之间的相关系数矩阵
   - 高相关提示(>0.7)
   - 期货对冲效果评估
   - 建议分散化操作

5. **期权特有风险**
   - 希腊值汇总 (总Delta、总Gamma、总Vega、总Theta)
   - 到期日警告 (30天内到期的合约)
   - 虚值期权风险提示

**验收标准**:
- [ ] 持仓热力图同时显示股票、期货、期权(不同图标)
- [ ] VaR显示"95% VaR (1日) = ¥3,200, 占总资产3.2%"
- [ ] 保证金占用率显示"65%, 安全边际35%"
- [ ] 强平预警表显示"IF2506.CFFEX距离强平3%, 黄色预警"
- [ ] 止损预警表显示"000001.SZ距离止损1.5%, 红色预警"
- [ ] 期权希腊值显示"总Delta: +125, 总Theta: -50/天"
- [ ] 相关性矩阵显示"600519与IF2506相关系数-0.45, 有效对冲"
- [ ] 自动刷新(每5秒获取最新价格)

**技术任务 (T156-T170)**:
- T156: VaR/CVaR计算引擎(历史模拟法, 支持期货杠杆)
- T157: 持仓集中度计算(按品种类型)
- T158: 保证金占用率计算
- T159: 强平风险评估引擎
- T160: 期权希腊值汇总计算
- T161: 行业/品种分类数据集成
- T162: 相关性计算(pandas.corr, 支持跨品种)
- T163: 止损/强平距离计算
- T164: 持仓热力图组件(Plotly treemap, 多品种)
- T165: 相关性热力图(Plotly heatmap)
- T166: UI页面 `12_risk_dashboard.py` 增强
- T167: 实时价格更新(自动刷新)
- T168: 预警规则配置(分品种)
- T169: 测试: VaR计算准确性(含期货杠杆)
- T170: 文档: 风险指标解释(含期货/期权)

**工期估算**: 5-6天

---

### US17 (P2): 多周期策略 - Multi-Timeframe Strategy

**优先级**: P2 - ADVANCED FEATURE

**用户场景**:
作为策略开发者,我想结合周线趋势和日线择时,以便提高入场精度,过滤假突破信号。

**核心需求**:
1. 周线趋势确认
   - 周线120MA方向判断
   - 周线MACD趋势
2. 日线择时信号
   - 日线突破 + 周线趋势一致
3. 跨周期回测验证
   - 对比: 纯日线 vs 周线+日线组合
4. UI选择周期组合

**验收标准**:
- [ ] 策略检测到"周线上升趋势,日线突破"生成BUY
- [ ] 回测对比: 纯日线Sharpe 1.5, 周线+日线Sharpe 1.8
- [ ] UI可选"日线"/"周线"/"日线+周线组合"
- [ ] 推荐卡片显示"周线趋势: ↑ 上升"

**技术任务 (T163-T172)**:
- T163: 周线数据获取(resample)
- T164: 周线指标计算
- T165: 多周期策略逻辑
- T166: 跨周期回测引擎
- T167: UI周期选择器
- T168: 测试: 周线+日线策略
- T169: 对比分析报告
- T170: 文档

**工期估算**: 3-4天(可选)

---

### US18 (P1): 组合策略UI/UX - Combination Strategy Interface ⭐ 提升至P1

**优先级**: P1 - CORE FEATURE (期货/期权核心价值)

**用户场景**:
作为期货/期权交易者,我想通过UI界面方便地构建组合策略(如跨期套利、蝶式价差),以便充分利用期货/期权的组合特性,而不是手动配置复杂的JSON。

**核心需求**:

1. **期货组合策略构建器**
   - 跨期套利: 买入近月+卖出远月
   - 跨品种套利: IF vs IC
   - 可视化多腿展示(每一腿的方向、数量)

2. **期权组合策略构建器**
   - 预设模板:
     - 备兑开仓 (Covered Call)
     - 保护性看跌 (Protective Put)
     - 跨式组合 (Straddle)
     - 蝶式价差 (Butterfly Spread)
   - 拖拽式构建: 选择期权合约 → 指定买/卖 → 指定数量
   - 实时损益图: 显示不同价格下的组合盈亏曲线

3. **组合策略回测**
   - 整体盈亏计算(考虑所有腿)
   - 保证金占用汇总
   - 希腊值汇总(期权组合)

4. **组合策略监控**
   - 实时显示所有腿的状态
   - 组合整体盈亏
   - 平仓操作: 一键平掉整个组合

**验收标准**:
- [ ] 可通过UI选择"跨期套利"模板,自动填充买近卖远
- [ ] 可拖拽构建蝶式价差期权组合(3个行权价)
- [ ] 实时显示组合损益图(X轴标的价格, Y轴盈亏)
- [ ] 回测显示组合整体Sharpe比率和保证金占用
- [ ] 持仓页面显示"组合"视图,可展开查看各腿

**技术任务 (T172-T182)**:
- T172: 组合策略数据模型设计 (multi-leg structure)
- T173: 期货组合策略模板(跨期/跨品种)
- T174: 期权组合策略模板(covered call/butterfly等)
- T175: UI组合策略构建器 (`11_strategy_builder.py`)
- T176: 拖拽式UI组件(期权合约选择器)
- T177: 实时损益图绘制 (Plotly)
- T178: 组合回测引擎(multi-leg backtest)
- T179: 组合保证金计算(考虑对冲效应)
- T180: 组合希腊值汇总(期权)
- T181: 持仓页面"组合视图"
- T182: 测试: 蝶式价差回测完整流程
- T183: 文档: 组合策略构建指南

**工期估算**: 5-6天

**⚠️ 提升为P1的理由**:
1. **期货/期权的核心价值在组合**: 单腿交易无法充分发挥衍生品优势
2. **用户体验决定成败**: 没有UI支持,用户需要手写JSON配置,门槛太高
3. **完整性要求**: US15提供后端能力,US18提供前端接口,二者缺一不可
4. **市场竞争力**: 专业交易系统必须支持组合策略,这是行业标准

---

### US19 (P2): 技术指标扩展 - Technical Indicators

**优先级**: P2 - STRATEGY ENHANCEMENT

**核心需求**:
1. 新增指标:
   - MACD (Moving Average Convergence Divergence)
   - KDJ (Stochastic Oscillator)
   - 布林带 (Bollinger Bands)
   - 成交量分型
2. 组合策略
3. 回测验证

**技术任务 (T184-T190)**:
- T184: MACD指标实现
- T185: KDJ指标实现
- T186: 布林带指标实现
- T187: 成交量分型识别
- T188: 组合策略测试
- T189: UI指标选择器
- T190: 文档

**工期估算**: 2-3天(可选)

---

## 📅 实施计划

### 阶段划分

**Phase 1 (Week 1): P0紧急优化** - 5-7天
- US11: 监视列表管理 (2-3天)
- US12: 回测并行化 (3-4天)

**Phase 2 (Week 2-3): P1核心增强** - 14-18天
- US13: 参数优化器 (4-5天)
- US14: 报告导出 (3-4天)
- US15: 期货与期权支持 (7-8天) ⭐ (含美式期权调研+配置管理模块)

**Phase 3 (Week 4-5): P1风险管理与组合策略** - 10-12天 ⭐ 调整
- US16: 风险监控 (5-6天, 含期货/期权风险)
- US18: 组合策略UI/UX (5-6天) ⭐ **提升为P1核心功能**

**Phase 4 (Week 5-6): P2可选功能** - 5-7天
- US17: 多周期策略 (可选, 3-4天)
- US19: 技术指标 (可选, 2-3天)

**总工期**:
- **P0+P1核心(含组合策略)**: 4.5-5.5周 (29-39天) ⭐ 推荐
- **含所有P2功能**: 5.5-7周 (34-46天)

**⚠️ 工期说明**:
1. US15需要重构策略基类和回测引擎,以实现品种隔离设计
2. **统一双数据源备份** - efinance主 + AkShare备,提高健壮性
3. **中心化配置管理** (新增) - Pydantic Settings 模块,类型安全+参数校验
4. **新增期权复杂性调研** (T159) - 美式期权提前行权影响分析
5. **US18提升为P1** - 组合策略是期货/期权核心价值,必须实现
6. 需充分测试: 期货主力合约切换、期权数据缺失、希腊值计算、降级策略、配置验证

---

## ✅ 成功标准

### 性能目标
- [ ] 10股票回测时间 < 3分钟(vs 当前10+分钟)
- [ ] UI响应时间 < 1秒(所有操作)
- [ ] 调度器执行时间 < 5分钟(20只股票)

### 功能目标
- [ ] 监视列表管理:100%通过UI操作,0硬编码
- [ ] 参数优化: 找到Sharpe提升>10%的参数组合
- [ ] 报告导出: 生成符合专业标准的PDF/Excel
- [ ] 期货/期权支持: 成功回测股指期货和50ETF期权策略
- [ ] 保证金计算: 准确率>99%, 无强平误判
- [ ] 风险监控: VaR计算误差<5%, 含期货杠杆风险
- [ ] 美式期权: 明确简化策略(V0.3仅到期行权),文档说明限制
- [ ] 组合策略(可选): 成功回测蝶式价差期权组合,UI可视化构建

### 用户体验目标
- [ ] 新用户15分钟内完成首次回测
- [ ] 所有核心操作 ≤3次点击
- [ ] 错误提示清晰易懂,提供解决方案
- [ ] 所有UI页面支持移动端访问(响应式)

---

## 🎯 V0.3后的未来展望

### V0.4 - 实盘交易准备 (2025 Q4)
- 券商API集成(华泰/国金)
- 实盘模式切换
- 订单管理系统
- 交易确认和风控

### V0.5 - 多用户与企业版 (2026 Q1)
- 用户认证和权限
- 多账户管理
- 团队协作功能
- 审计日志增强

### V0.6 - AI增强 (2026 Q2)
- LLM驱动的智能诊断
- 自然语言策略描述
- 市场情绪分析
- 新闻事件关联

---

## 📝 附录

### 依赖安装
```bash
# US14报告导出
pip install reportlab openpyxl python-docx

# US15期货/期权支持 - 数据集成
pip install efinance  # 主数据源 (已安装)
pip install akshare   # 备份数据源 ⭐
pip install scipy numpy  # 期权希腊值计算

# US15期货/期权支持 - 配置管理 ⭐ 新增
pip install pydantic[dotenv]  # 中心化配置管理,类型安全

# US16风险指标
pip install scipy  # VaR/CVaR计算
```

### 配置管理架构

**⚠️ 配置管理中心化设计**:

为了提高系统稳定性和可维护性,V0.3 引入**中心化配置管理模块**:

```python
# config/settings.py - 使用 Pydantic 进行类型校验和管理

from pydantic import BaseSettings, validator, Field
from typing import Literal

class DataSourceSettings(BaseSettings):
    """数据源配置"""
    primary: Literal['efinance'] = 'efinance'
    fallback: Literal['akshare'] = 'akshare'
    auto_fallback: bool = True

    cache_enabled: bool = True
    cache_dir: str = './data/cache'
    cache_expiry_days: int = 7

class FuturesSettings(BaseSettings):
    """期货配置"""
    enabled: bool = True
    default_margin_rate: float = Field(0.15, ge=0.05, le=0.50)
    force_close_margin_rate: float = Field(0.10, ge=0.05, le=0.30)

    @validator('force_close_margin_rate')
    def validate_force_close_rate(cls, v, values):
        if 'default_margin_rate' in values and v >= values['default_margin_rate']:
            raise ValueError('强平线必须低于保证金率')
        return v

class OptionsSettings(BaseSettings):
    """期权配置"""
    enabled: bool = True
    pricing_model: Literal['black_scholes'] = 'black_scholes'
    risk_free_rate: float = Field(0.03, ge=0.0, le=0.10)

class RiskSettings(BaseSettings):
    """风险监控配置"""
    var_confidence: float = Field(0.95, ge=0.90, le=0.99)
    refresh_interval: int = Field(5, ge=1, le=60)
    margin_warning_threshold: float = Field(0.70, ge=0.50, le=0.90)

class AppSettings(BaseSettings):
    """应用主配置"""
    data_source: DataSourceSettings = DataSourceSettings()
    futures: FuturesSettings = FuturesSettings()
    options: OptionsSettings = OptionsSettings()
    risk: RiskSettings = RiskSettings()

    class Config:
        env_file = '.env'
        env_nested_delimiter = '__'

# 全局单例
settings = AppSettings()
```

**优势**:
1. ✅ **类型安全**: Pydantic 自动类型校验,避免配置错误
2. ✅ **参数验证**: 自定义 validator,确保配置逻辑正确(如强平线<保证金率)
3. ✅ **IDE支持**: 代码提示和自动补全
4. ✅ **文档生成**: 可自动生成配置文档
5. ✅ **测试友好**: 易于 mock 和单元测试

**使用方式**:
```python
from config.settings import settings

# 类型安全的访问
margin_rate = settings.futures.default_margin_rate  # float
if settings.data_source.auto_fallback:  # bool
    # 降级逻辑
    pass
```

### 配置示例

**.env新增** (支持嵌套结构,使用 `__` 分隔符):
```env
# 数据源配置 (US15 数据集成) - 统一双数据源备份 ⭐
DATA_SOURCE__PRIMARY=efinance      # 主数据源 (股票/期货/期权)
DATA_SOURCE__FALLBACK=akshare      # 备用数据源 (股票/期货/期权) ⭐
DATA_SOURCE__AUTO_FALLBACK=true    # 主数据源失败时自动降级

# 数据缓存配置
DATA_SOURCE__CACHE_ENABLED=true
DATA_SOURCE__CACHE_DIR=./data/cache
DATA_SOURCE__CACHE_EXPIRY_DAYS=7

# 期货配置 (US15)
FUTURES__ENABLED=true
FUTURES__DEFAULT_MARGIN_RATE=0.15     # 默认保证金率15%
FUTURES__FORCE_CLOSE_MARGIN_RATE=0.10 # 强平线10%

# 期权配置 (US15)
OPTIONS__ENABLED=true
OPTIONS__PRICING_MODEL=black_scholes  # Black-Scholes模型
OPTIONS__RISK_FREE_RATE=0.03          # 无风险利率 3%

# 风险监控配置 (US16)
RISK__VAR_CONFIDENCE=0.95                  # VaR置信度
RISK__REFRESH_INTERVAL=5                   # 刷新间隔(秒)
RISK__MARGIN_WARNING_THRESHOLD=0.70        # 保证金预警阈值70%
```

**注意**: 使用 `__` (双下划线) 作为嵌套分隔符,Pydantic 会自动解析为嵌套结构。

### 架构设计说明

**数据适配器架构 (统一双数据源备份):** ⭐ 新增
```
┌─────────────────────────────────────────────────────┐
│  业务层 (Strategy/BacktestEngine)                   │
│  - 只调用统一接口 get_bars(), get_latest_price()    │
└─────────────────┬───────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────┐
│  适配器层 (DataAdapter) - 扩展现有 market_api.py    │
├─────────────────┬─────────────┬─────────────────────┤
│ StockDataAdapter│FuturesData  │OptionsDataAdapter   │
│                 │Adapter      │                     │
│ - efinance     │- efinance   │- efinance           │
│ - AkShare ⭐   │- AkShare ⭐ │- AkShare ⭐         │
│   (备份)       │  (备份)     │  (备份)             │
│ - 数据缓存     │- 主力合约   │- 希腊值计算         │
│ - 自动降级     │- 自动降级   │- 自动降级           │
└─────────────────┴─────────────┴─────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────┐
│  数据源层 (External APIs)                            │
│  - efinance (主数据源: 股票/期货/期权)               │
│  - AkShare (备份数据源: 股票/期货/期权) ⭐           │
└─────────────────────────────────────────────────────┘
```

**数据适配器统一接口:** (扩展现有 market_api.py)
```python
class BaseDataAdapter(ABC):
    """基于 efinance 的数据适配器基类"""

    @abstractmethod
    def get_bars(self, symbol, start, end, freq='daily') -> pd.DataFrame:
        """获取K线数据 (统一列名: date,open,high,low,close,volume)"""

    @abstractmethod
    def get_latest_price(self, symbol) -> float:
        """获取最新价格"""

    @abstractmethod
    def get_contract_info(self, symbol) -> dict:
        """获取合约信息 (期货/期权专用)"""

    @abstractmethod
    def validate_data(self, df: pd.DataFrame) -> bool:
        """数据完整性校验"""

# 股票适配器扩展 (增加 AkShare 备份) ⭐
class StockDataAdapter(BaseDataAdapter):
    def get_bars(self, symbol, start, end, freq='daily'):
        try:
            data = efinance.stock.get_quote_history(symbol, start, end)
            return self._normalize_data(data, source='efinance')
        except Exception as e:
            logger.warning(f"股票 {symbol}: efinance失败, 降级到AkShare")
            data = akshare.stock_zh_a_hist(symbol, start, end)
            return self._normalize_data(data, source='akshare')

# 期货适配器新增 (含 AkShare 备份)
class FuturesDataAdapter(BaseDataAdapter):
    def get_bars(self, symbol, start, end, freq='daily'):
        try:
            data = efinance.futures.get_quote_history(symbol, start, end)
            return self._normalize_data(data, source='efinance')
        except Exception as e:
            logger.warning(f"期货 {symbol}: efinance失败, 降级到AkShare")
            data = akshare.futures_zh_daily(symbol, start, end)
            return self._normalize_data(data, source='akshare')

    def get_contract_info(self, symbol):
        # 返回合约乘数、保证金率、到期日等
        pass

# 期权适配器新增 (含 AkShare 备份)
class OptionsDataAdapter(BaseDataAdapter):
    def get_bars(self, symbol, start, end, freq='daily'):
        try:
            data = efinance.option.get_quote_history(symbol, start, end)
            # 计算 Black-Scholes 希腊值
            return self._normalize_data(data, source='efinance')
        except Exception as e:
            logger.warning(f"期权 {symbol}: efinance失败, 降级到AkShare")
            data = akshare.option_zh_daily(symbol, start, end)
            return self._normalize_data(data, source='akshare')

    def _normalize_data(self, df, source):
        """统一数据格式 + 计算希腊值"""
        df = super()._normalize_data(df, source)
        # 增加希腊值计算
        df = self._calculate_greeks(df)
        return df
```

**策略基类继承关系:**
```
BaseStrategy (抽象基类)
├── StockStrategy (股票策略)
│   ├── KrollStrategy
│   └── MomentumStrategy
├── FuturesStrategy (期货策略)
│   ├── TrendFollowingStrategy (趋势跟踪)
│   ├── ArbitrageStrategy (跨期套利)
│   └── HedgingStrategy (对冲策略)
└── OptionsStrategy (期权策略)
    ├── CoveredCallStrategy (备兑开仓)
    ├── ProtectivePutStrategy (保护性看跌)
    └── StraddleStrategy (跨式组合)
```

**回测引擎分离:**
```
BacktestEngine (抽象基类)
├── StockBacktestEngine
│   - 资金管理: 全额制
│   - 交易规则: T+1
│   - 风险控制: 止损/止盈
│   - 数据适配器: StockDataAdapter
├── FuturesBacktestEngine
│   - 资金管理: 保证金制 (逐日盯市)
│   - 交易规则: T+0, 双向持仓
│   - 风险控制: 强平、移仓换月
│   - 数据适配器: FuturesDataAdapter
└── OptionsBacktestEngine
    - 资金管理: 权利金+保证金
    - 交易规则: T+0, 到期处理
    - 风险控制: 希腊值监控、时间衰减
    - 数据适配器: OptionsDataAdapter
```

**关键设计模式:**
1. **工厂模式**: `StrategyFactory.create(contract_type)` 自动选择策略类
2. **策略模式**: 不同品种的交易逻辑完全隔离
3. **模板方法**: `BaseStrategy` 定义回测流程,子类实现具体逻辑
4. **适配器模式**: 扩展现有 market_api.py,统一数据接口 ⭐ 简化
5. **单一数据源**: 全部使用 efinance,降低维护成本 ⭐ 简化

### 数据库Schema新增

```sql
-- US15: 合约信息表
CREATE TABLE contract_info (
    contract_code TEXT PRIMARY KEY,     -- IF2506.CFFEX
    contract_type TEXT NOT NULL,        -- stock/future/option
    underlying TEXT,                    -- 标的代码
    multiplier REAL DEFAULT 1.0,        -- 合约乘数
    margin_rate REAL,                   -- 保证金率
    tick_size REAL,                     -- 最小变动价位
    expire_date TEXT,                   -- 到期日
    delivery_method TEXT,               -- 交割方式(现金/实物)
    option_type TEXT,                   -- 期权类型(call/put)
    strike_price REAL,                  -- 行权价
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- US15: 监视列表增加品种类型字段
ALTER TABLE watchlist ADD COLUMN contract_type TEXT DEFAULT 'stock';

-- US15: 持仓表增加方向字段 (期货双向持仓)
ALTER TABLE positions ADD COLUMN direction TEXT DEFAULT 'long';  -- long/short

-- US15: 交易记录增加保证金字段
ALTER TABLE trades ADD COLUMN margin_used REAL DEFAULT 0.0;
ALTER TABLE trades ADD COLUMN direction TEXT DEFAULT 'long';
```

---

**Document Version**: v1.6
**Created**: 2025-10-22
**Last Updated**: 2025-10-22
**Status**: 📝 提案阶段 - 待审批

## 📋 修订历史

### v1.6 (2025-10-22) - US18提升P1 + 中心化配置管理 ⭐ 最终版
- 🎯 **US18提升为P1优先级** ⭐ 关键决策
  - 理由: 组合策略是期货/期权核心价值,必须实现
  - Phase 3调整: US16 + US18 作为P1核心功能
  - 总工期(P0+P1): 4.5-5.5周 (含组合策略)
- ⚙️ **新增中心化配置管理模块** ⭐ 重要
  - 使用 Pydantic BaseSettings 实现类型安全
  - 配置分组: DataSource, Futures, Options, Risk
  - 自定义 validator (强平线<保证金率等业务逻辑校验)
  - 支持嵌套结构 (.env使用`__`双下划线分隔符)
  - 新增T141技术任务: config/settings.py实现
  - 新增T166测试任务: 配置校验测试
- 📦 **依赖新增**: pydantic[dotenv] - 配置管理核心库
- 📅 **工期说明补充**: 明确6项关键因素

### v1.5 (2025-10-22) - 增加期权复杂性和组合策略考虑
- ⚠️ **新增期权复杂性说明** - 美式期权提前行权问题
  - V0.3简化策略: 美式期权仅到期行权
  - 新增T159调研任务: 评估提前行权影响
  - V0.4规划: 完整支持提前行权最优策略
- 🎨 **新增US18: 组合策略UI/UX** ⭐ 重要
  - 期货组合: 跨期套利、跨品种套利
  - 期权组合: 蝶式价差、跨式组合等
  - 可视化构建器: 拖拽式多腿策略构建
  - 实时损益图: 不同价格下的组合盈亏曲线
  - 工期: 5-6天 (建议优先实现)
- 📅 **实施计划调整**:
  - US15工期: 6-7天 → 7-8天 (含美式期权调研)
  - 新增Phase 3: US18组合策略 (可选但重要)
  - 总工期(含组合): 4.5-5.5周
- 💡 **设计说明**: 期货/期权的核心价值在于组合,单腿交易无法发挥优势

### v1.4 (2025-10-22) - 统一双数据源备份
- 🎯 **所有品种统一使用双数据源备份**
  - 主数据源: efinance (股票/期货/期权)
  - 备份数据源: AkShare (股票/期货/期权) ⭐
  - 统一降级策略: 所有品种 efinance失败→AkShare
  - 对业务层透明,无感知
- 🛡️ **全面提高健壮性**: 所有品种都有双重保障
- ⚙️ **配置简化**: 统一配置 DATA_SOURCE_PRIMARY/FALLBACK
- 📦 **技术任务增强**: T142 股票适配器增强, T165 统一降级测试
- ✅ **验收全面化**: 验证所有品种的降级策略
- 💡 **设计统一**: 代码简洁,易于维护

### v1.3 (2025-10-22) - 增加期货数据备份
- 🔄 **新增 AkShare 作为期货数据备份源**
  - 备份数据源: AkShare (仅期货)
- 🛡️ **提高健壮性**: 期货数据有双重保障

### v1.2 (2025-10-22) - 简化数据源设计
- 🎯 **统一主数据源为 efinance**
  - 移除 Tushare/CTP 等复杂数据源方案
  - 股票/期货/期权全部优先使用 efinance
  - 无需管理多个API密钥
- 📉 **工期优化**: 7-9天 → 6-7天
- 📦 **架构简化**: 扩展现有 market_api.py,复用缓存机制

### v1.1 (2025-10-22)
- ❌ **移除 US15 推送通知中心** - 暂缓至V0.4版本
- ✅ **新增 US15 期货与期权品种支持** - 扩展到多品种交易
- 🏗️ **强调架构分离设计** - 策略基类和回测引擎按品种分离 (StockStrategy/FuturesStrategy/OptionsStrategy)
- 📊 **新增品种差异对比表** - 明确股票/期货/期权的交易机制差异
- 🔌 **新增数据集成章节** - 数据源对比、适配器架构
- 🔧 **增强 US16 风险监控仪表盘** - 支持期货保证金风险和期权希腊值
- 📦 **新增数据库Schema** - 合约信息表、持仓方向、保证金字段
- 📐 **新增架构设计说明** - 数据适配器架构、策略继承关系、回测引擎分离

### v1.0 (2025-10-22)
- 初始版本创建
