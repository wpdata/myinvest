# MyInvest V0.3 - Production-Ready Enhancement 规划提案

**版本**: V0.3
**主题**: Production-Ready Enhancement (生产就绪增强)
**创建日期**: 2025-10-22
**状态**: 📝 提案阶段
**依赖**: V0.2 完整完成

---

## 🎯 V0.3 目标

基于 V0.2 的多策略回测与自动化系统,V0.3 聚焦在**提升生产可用性**和**用户体验优化**:

1. **解决运营痛点** - 监视列表硬编码、回测性能慢
2. **增强决策支持** - 参数优化、风险监控、报告导出
3. **提升便利性** - 推送通知、批量操作、智能诊断

**不在V0.3范围**:
- ❌ 真实券商API集成(推迟到V0.4)
- ❌ 实盘交易模式(推迟到V0.4)
- ❌ 多用户/权限系统(推迟到V0.5)
- ❌ 分钟级/Tick数据(推迟到V0.5)

---

## 📦 User Stories

### US11 (P0): 监视列表管理 - Watchlist Management

**优先级**: P0 - BLOCKING (当前硬编码严重影响使用)

**用户场景**:
作为投资者,我想通过UI界面管理监视列表,以便灵活调整跟踪的股票池,而不是修改代码。

**核心需求**:
1. UI添加/删除股票到监视列表
2. 分组管理:
   - 核心持仓 (Core Holdings)
   - 观察池 (Watchlist)
   - 行业板块 (Sector Groups)
3. 自动同步到调度器
4. 支持批量导入(CSV)
5. 显示每只股票的状态(活跃/暂停)

**验收标准**:
- [ ] 可通过UI添加股票 600519.SH 到监视列表
- [ ] 调度器自动获取最新监视列表(不需要重启)
- [ ] 可将股票分组到"核心持仓"并仅为此组生成推荐
- [ ] 批量导入10只股票CSV成功
- [ ] 暂停某股票后,调度器跳过该股票

**技术任务 (T101-T110)**:
- T101: 数据库表 `watchlist` schema设计
- T102: CRUD API实现 (`watchlist_db.py`)
- T103: UI页面 `9_watchlist.py`
- T104: 分组管理逻辑
- T105: 调度器集成(动态加载)
- T106: CSV批量导入
- T107: 股票状态管理(active/paused)
- T108: 测试: 添加/删除/分组
- T109: 测试: 调度器动态加载
- T110: 文档更新

**工期估算**: 2-3天

---

### US12 (P0): 回测并行化 - Parallel Backtesting

**优先级**: P0 - CRITICAL PERFORMANCE (当前10股票需10+分钟)

**用户场景**:
作为投资者,我想同时回测多只股票,以便快速评估整个投资组合的策略表现,而不是等待漫长的串行执行。

**核心需求**:
1. 使用 ProcessPoolExecutor 并行回测
2. 实时进度条(处理中股票/总股票)
3. 批量回测报告汇总
4. 错误隔离(单股票失败不影响其他)
5. CPU核心数自动检测(max_workers)

**验收标准**:
- [ ] 回测10只股票时间 < 3分钟(vs 当前10+分钟)
- [ ] 进度条实时更新"3/10股票已完成"
- [ ] 单股票失败不中断整体回测
- [ ] 批量报告显示所有股票的Sharpe/Drawdown对比表
- [ ] 自动使用8核CPU并行(如果可用)

**技术任务 (T111-T118)**:
- T111: 重构 `BacktestRunner` 支持单股票独立运行
- T112: 实现 `ParallelBacktestRunner` (ProcessPoolExecutor)
- T113: 进度跟踪机制(Queue/Manager)
- T114: 错误处理和重试逻辑
- T115: 批量报告生成器
- T116: UI实时进度条更新
- T117: 测试: 10股票并行 vs 串行性能对比
- T118: CPU核心数配置

**工期估算**: 3-4天

---

### US13 (P1): 策略参数优化器 - Parameter Optimizer

**优先级**: P1 - CORE ENHANCEMENT

**用户场景**:
作为策略开发者,我想自动搜索最优参数组合,以便找到最佳的止损/止盈/仓位配置,而不是依赖经验猜测。

**核心需求**:
1. 网格搜索(Grid Search)
   - 止损范围: 2%-5%, 步长0.5%
   - 止盈范围: 3%-10%, 步长1%
   - 仓位范围: 8%-20%, 步长2%
2. Walk-Forward验证
   - 训练期: 2年
   - 测试期: 1年
   - 滚动窗口验证
3. 参数热力图可视化
   - X轴止损, Y轴止盈, 颜色Sharpe
4. 最优参数推荐
5. 过拟合检测(训练vs测试Sharpe差异)

**验收标准**:
- [ ] 网格搜索7×8×7=392组参数组合
- [ ] 显示热力图: Sharpe最高的参数在(止损3%, 止盈6%)
- [ ] Walk-Forward验证显示训练Sharpe=1.8, 测试Sharpe=1.5(健康)
- [ ] 警告过拟合: "训练Sharpe 2.5, 测试Sharpe 0.8, 可能过拟合"
- [ ] 保存最优参数到策略配置

**技术任务 (T119-T128)**:
- T119: 网格搜索引擎 (`parameter_optimizer.py`)
- T120: Walk-Forward验证逻辑
- T121: 参数空间定义(止损/止盈/仓位范围)
- T122: 热力图生成(Plotly heatmap)
- T123: 过拟合检测算法
- T124: 最优参数推荐逻辑
- T125: UI页面 `10_parameter_optimizer.py`
- T126: 并行优化(复用US12的并行引擎)
- T127: 测试: Kroll策略参数优化
- T128: 文档: 参数优化最佳实践

**工期估算**: 4-5天

---

### US14 (P1): 报告导出系统 - Report Export

**优先级**: P1 - USER EXPERIENCE

**用户场景**:
作为投资者,我想导出回测报告PDF和交易记录Excel,以便离线查看、打印或分享给投资顾问。

**核心需求**:
1. **回测报告PDF**
   - 封面: 策略名称、回测期间、生成日期
   - 第1页: 性能指标表格
   - 第2页: 权益曲线图
   - 第3页: 回撤分析图
   - 第4页: 交易历史表格(前50笔)
   - 页脚: 免责声明

2. **交易记录Excel**
   - Sheet1: 交易明细(买入/卖出/盈亏)
   - Sheet2: 月度汇总
   - Sheet3: 持仓分析
   - 格式化: 颜色标记盈利/亏损

3. **持仓报表Word**
   - 当前持仓表格
   - 风险指标(VaR, 集中度)
   - 建议操作

**验收标准**:
- [ ] 点击"导出PDF"生成 `backtest_report_600519_20251022.pdf`
- [ ] PDF包含所有图表(权益曲线、回撤图)和表格
- [ ] Excel有3个工作表,盈利行标绿色,亏损行标红色
- [ ] Word报表包含当前持仓和风险指标
- [ ] 所有报告包含"本报告仅供参考,不构成投资建议"免责声明

**技术任务 (T129-T138)**:
- T129: PDF生成器 (`reportlab` 或 `weasyprint`)
- T130: PDF模板设计(封面/章节)
- T131: Excel生成器 (`openpyxl`)
- T132: Excel样式和格式化
- T133: Word生成器 (`python-docx`)
- T134: 报告数据准备器(从数据库提取)
- T135: UI导出按钮集成
- T136: 测试: 生成各类报告
- T137: 样式优化(公司Logo, 颜色主题)
- T138: 文档: 报告模板定制指南

**工期估算**: 3-4天

---

### US15 (P1): 推送通知中心 - Notification Center

**优先级**: P1 - CONVENIENCE

**用户场景**:
作为投资者,我想在每日推荐生成后收到邮件通知,在触发止损时收到短信,以便及时响应市场变化,而不需要频繁登录系统。

**核心需求**:
1. **每日推荐邮件推送**
   - 触发: 调度器生成推荐后
   - 内容: 推荐摘要(股票/操作/止损止盈)
   - 格式: HTML邮件+图表
   - 时间: 08:35(调度器执行后5分钟)

2. **止损触发短信预警**
   - 触发: 当前价 ≤ 止损价
   - 内容: "600519.SH触发止损: 当前1650, 止损1600"
   - 渠道: 阿里云短信/腾讯云短信

3. **微信企业号推送**(可选)
   - 推荐通知
   - 重要事件(策略审批通过)

4. **通知偏好设置**
   - UI配置: 启用/禁用各类通知
   - 推送时间设置
   - 接收渠道选择

**验收标准**:
- [ ] 调度器执行后,收到包含3条推荐的HTML邮件
- [ ] 模拟止损触发,收到短信"600519.SH触发止损"
- [ ] UI可配置"启用每日推荐邮件"开关
- [ ] 邮件包含权益曲线图片(内嵌或附件)
- [ ] 所有通知记录到 `notification_log` 表

**技术任务 (T139-T150)**:
- T139: 邮件发送器 (`smtplib` + `email.mime`)
- T140: HTML邮件模板设计
- T141: 短信发送器(阿里云SDK)
- T142: 微信企业号集成(可选)
- T143: 通知规则引擎(何时发送)
- T144: 通知偏好配置表 `notification_preferences`
- T145: UI配置页面 `11_notification_settings.py`
- T146: 调度器集成(推荐生成后触发)
- T147: 止损检测逻辑
- T148: 测试: 邮件/短信发送
- T149: 错误处理(发送失败重试)
- T150: 文档: 通知配置指南

**工期估算**: 3-4天

---

### US16 (P1): 风险监控仪表盘 - Risk Dashboard

**优先级**: P1 - RISK MANAGEMENT

**用户场景**:
作为投资者,我想实时查看持仓风险指标,以便主动管理集中度风险和市场风险,避免黑天鹅事件。

**核心需求**:
1. **持仓热力图**
   - 气泡大小: 仓位占比
   - 颜色: 盈亏比例(绿盈红亏)
   - 标签: 股票代码

2. **风险指标**
   - VaR (95%置信度, 1日风险价值)
   - CVaR (条件风险价值)
   - 最大单一持仓占比
   - 行业集中度

3. **止损触发预警**
   - 表格: 距离止损价的百分比
   - 排序: 最接近止损的排在前面
   - 预警级别: 距离<2% 红色, 2-5% 黄色

4. **相关性分析**
   - 持仓股票之间的相关系数矩阵
   - 高相关提示(>0.7)
   - 建议分散化操作

**验收标准**:
- [ ] 持仓热力图显示5只股票,最大仓位(600519)气泡最大
- [ ] VaR显示"95% VaR (1日) = ¥3,200, 占总资产3.2%"
- [ ] 止损预警表显示"000001.SZ距离止损1.5%, 红色预警"
- [ ] 相关性矩阵显示"600519与000858相关系数0.82, 建议分散"
- [ ] 自动刷新(每5秒获取最新价格)

**技术任务 (T151-T162)**:
- T151: VaR/CVaR计算引擎(历史模拟法)
- T152: 持仓集中度计算
- T153: 行业分类数据集成
- T154: 相关性计算(pandas.corr)
- T155: 止损距离计算
- T156: 持仓热力图组件(Plotly treemap)
- T157: 相关性热力图(Plotly heatmap)
- T158: UI页面 `12_risk_dashboard.py`
- T159: 实时价格更新(自动刷新)
- T160: 预警规则配置
- T161: 测试: VaR计算准确性
- T162: 文档: 风险指标解释

**工期估算**: 4-5天

---

### US17 (P2): 多周期策略 - Multi-Timeframe Strategy

**优先级**: P2 - ADVANCED FEATURE

**用户场景**:
作为策略开发者,我想结合周线趋势和日线择时,以便提高入场精度,过滤假突破信号。

**核心需求**:
1. 周线趋势确认
   - 周线120MA方向判断
   - 周线MACD趋势
2. 日线择时信号
   - 日线突破 + 周线趋势一致
3. 跨周期回测验证
   - 对比: 纯日线 vs 周线+日线组合
4. UI选择周期组合

**验收标准**:
- [ ] 策略检测到"周线上升趋势,日线突破"生成BUY
- [ ] 回测对比: 纯日线Sharpe 1.5, 周线+日线Sharpe 1.8
- [ ] UI可选"日线"/"周线"/"日线+周线组合"
- [ ] 推荐卡片显示"周线趋势: ↑ 上升"

**技术任务 (T163-T172)**:
- T163: 周线数据获取(resample)
- T164: 周线指标计算
- T165: 多周期策略逻辑
- T166: 跨周期回测引擎
- T167: UI周期选择器
- T168: 测试: 周线+日线策略
- T169: 对比分析报告
- T170: 文档

**工期估算**: 3-4天(可选)

---

### US18 (P2): 技术指标扩展 - Technical Indicators

**优先级**: P2 - STRATEGY ENHANCEMENT

**核心需求**:
1. 新增指标:
   - MACD (Moving Average Convergence Divergence)
   - KDJ (Stochastic Oscillator)
   - 布林带 (Bollinger Bands)
   - 成交量分型
2. 组合策略
3. 回测验证

**技术任务 (T173-T180)**:
- T173: MACD指标实现
- T174: KDJ指标实现
- T175: 布林带指标实现
- T176: 成交量分型识别
- T177: 组合策略测试
- T178: UI指标选择器
- T179: 文档

**工期估算**: 2-3天(可选)

---

## 📅 实施计划

### 阶段划分

**Phase 1 (Week 1): P0紧急优化** - 5-7天
- US11: 监视列表管理 (2-3天)
- US12: 回测并行化 (3-4天)

**Phase 2 (Week 2): P1核心增强** - 10-13天
- US13: 参数优化器 (4-5天)
- US14: 报告导出 (3-4天)
- US15: 推送通知 (3-4天)

**Phase 3 (Week 3): P1风险管理 + P2可选** - 4-5天
- US16: 风险监控 (4-5天)
- US17: 多周期策略 (可选, 3-4天)
- US18: 技术指标 (可选, 2-3天)

**总工期**: 3-4周

---

## ✅ 成功标准

### 性能目标
- [ ] 10股票回测时间 < 3分钟(vs 当前10+分钟)
- [ ] UI响应时间 < 1秒(所有操作)
- [ ] 调度器执行时间 < 5分钟(20只股票)

### 功能目标
- [ ] 监视列表管理:100%通过UI操作,0硬编码
- [ ] 参数优化: 找到Sharpe提升>10%的参数组合
- [ ] 报告导出: 生成符合专业标准的PDF/Excel
- [ ] 推送通知: 每日推荐邮件送达率>95%
- [ ] 风险监控: VaR计算误差<5%

### 用户体验目标
- [ ] 新用户15分钟内完成首次回测
- [ ] 所有核心操作 ≤3次点击
- [ ] 错误提示清晰易懂,提供解决方案
- [ ] 所有UI页面支持移动端访问(响应式)

---

## 🎯 V0.3后的未来展望

### V0.4 - 实盘交易准备 (2025 Q4)
- 券商API集成(华泰/国金)
- 实盘模式切换
- 订单管理系统
- 交易确认和风控

### V0.5 - 多用户与企业版 (2026 Q1)
- 用户认证和权限
- 多账户管理
- 团队协作功能
- 审计日志增强

### V0.6 - AI增强 (2026 Q2)
- LLM驱动的智能诊断
- 自然语言策略描述
- 市场情绪分析
- 新闻事件关联

---

## 📝 附录

### 依赖安装
```bash
# US14报告导出
pip install reportlab openpyxl python-docx

# US15推送通知
pip install aliyun-python-sdk-core aliyun-python-sdk-dysmsapi

# US16风险指标
pip install scipy
```

### 配置示例

**.env新增:**
```env
# US15推送通知
EMAIL_ENABLED=true
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USER=your_email@gmail.com
EMAIL_PASSWORD=your_app_password

SMS_ENABLED=false
ALIYUN_ACCESS_KEY=your_key
ALIYUN_ACCESS_SECRET=your_secret

# US16风险监控
RISK_VAR_CONFIDENCE=0.95
RISK_REFRESH_INTERVAL=5
```

---

**Document Version**: v1.0
**Created**: 2025-10-22
**Status**: 📝 提案阶段 - 待审批
