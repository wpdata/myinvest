# 📊 参数优化器使用指南

## 一、功能概述

参数优化器通过**网格搜索**自动测试大量参数组合，找出最优的止损/止盈/仓位配置。

### 核心功能

1. **网格搜索**: 测试所有参数组合（如 5×8×7 = 280 种）
2. **前推验证**: 2年训练 + 1年测试，检测过拟合
3. **可视化分析**: 热力图展示参数性能分布
4. **Top N 推荐**: 返回最优的5组参数组合

---

## 二、快速开始（5步）

### 步骤 1: 选择策略

在侧边栏选择要优化的策略：
- **120日均线突破策略** (ma_breakout_120) - 趋势跟随
- **MA60+RSI+波动率策略** (ma60_rsi_volatility) - 风险控制
- **融合策略** (fusion_strategy) - 综合策略

**推荐**: 从 `ma_breakout_120` 开始，逻辑简单易理解。

---

### 步骤 2: 输入股票代码

**示例代码：**
```
600519.SH  (贵州茅台 - 大盘股，流动性好)
000001.SZ  (平安银行)
510300.SH  (沪深300ETF)
```

**选股建议：**
- ✅ 大盘蓝筹股（流动性好，数据完整）
- ✅ 历史悠久的股票（有足够历史数据）
- ❌ 避免新股、ST股、停牌股

---

### 步骤 3: 设置日期范围

**最小要求：** 3年（1095天）

**推荐配置：**
```
开始日期: 2020-01-01
结束日期: 2025-01-01
总时长: 5年
```

**为什么需要3年+？**
- 前推验证需要: 2年训练 + 1年测试 = 3年
- 覆盖不同市场环境（牛市、熊市、震荡市）
- 更稳健的参数验证

---

### 步骤 4: 配置参数范围

#### 止损参数 (Stop Loss)
```
最小值: 5%
最大值: 25%
步长: 5%

生成: [5, 10, 15, 20, 25]  → 5个值
```

**含义:** 当股票从最高点回撤超过 X% 时卖出止损。

**设置建议:**
- 波动大的股票: 10%-30%
- 波动小的股票: 5%-15%

---

#### 止盈参数 (Take Profit)
```
最小值: 10%
最大值: 40%
步长: 5%

生成: [10, 15, 20, 25, 30, 35, 40]  → 7个值
```

**含义:** 当盈利达到 X% 时卖出止盈。

**设置建议:**
- 趋势策略: 20%-50% (让利润奔跑)
- 波段策略: 10%-30% (快进快出)

---

#### 仓位参数 (Position Size)
```
最小值: 10%
最大值: 50%
步长: 10%

生成: [10, 20, 30, 40, 50]  → 5个值
```

**含义:** 每次买入使用账户资金的 X%。

**设置建议:**
- 保守: 10%-30%
- 激进: 40%-60%
- 单股票最大不超过 60%

---

### 步骤 5: 启动优化

**总组合数 = 5 × 7 × 5 = 175 种**

预计耗时: 175 × 2秒 = 6分钟

点击 **"🚀 开始优化"** 按钮。

---

## 三、结果解读

### 1. 最优参数卡片

```
🏆 最优参数
├─ 止损比例: 15%
├─ 止盈比例: 30%
└─ 仓位比例: 30%

性能指标:
├─ 夏普比率: 1.85  (风险调整后收益)
├─ 总收益率: 45.2%
├─ 最大回撤: -18.3%
└─ 胜率: 58.5%
```

**指标说明:**

| 指标 | 含义 | 理想值 |
|------|------|--------|
| 夏普比率 | 风险调整后收益 | > 1.0 为优秀 |
| 总收益率 | 期间总回报 | 越高越好 |
| 最大回撤 | 最大亏损幅度 | < 30% |
| 胜率 | 盈利交易占比 | > 50% |

---

### 2. 前推验证结果

```
🔄 前推验证结果

训练集表现 (2020-2022):
├─ 夏普比率: 2.1
└─ 总收益率: 52%

测试集表现 (2022-2023):
├─ 夏普比率: 1.8
└─ 总收益率: 38%

过拟合检测:
├─ Sharpe差距: 0.3  (2.1 - 1.8)
└─ 风险等级: 🟢 LOW (良好)
```

**判断标准:**

| Sharpe差距 | 风险等级 | 建议 |
|-----------|---------|------|
| < 0.5 | 🟢 LOW | ✅ 参数稳健，可使用 |
| 0.5 - 1.0 | 🟡 MEDIUM | ⚠️ 谨慎使用，建议降低仓位 |
| > 1.0 | 🔴 HIGH | ❌ 严重过拟合，不推荐 |

---

### 3. 热力图分析

**止损 vs 止盈热力图**

```
     止盈 →
     10%  20%  30%  40%
止  5%  0.5  0.8  1.2  0.9
损 10%  0.9  1.3  1.8  1.5  ← 最优区域
↓  15%  1.1  1.5  2.1  1.7
   20%  0.8  1.2  1.6  1.3
```

**图例:** 颜色越深 = 夏普比率越高

**解读:**
- 红色区域: 性能差
- 黄色区域: 性能一般
- 绿色区域: 性能优秀 ✅

**发现:**
- 止损 10%-15% + 止盈 30% 表现最好
- 止损过小 (5%) 会被频繁止损
- 止盈过大 (40%) 难以达到

---

### 4. Top 5 参数组合

| 排名 | 止损% | 止盈% | 仓位% | 夏普比率 | 总收益率 |
|------|------|------|------|---------|---------|
| 1 | 15 | 30 | 30 | 2.10 | 45.2% |
| 2 | 10 | 35 | 25 | 2.05 | 42.8% |
| 3 | 15 | 25 | 30 | 1.98 | 40.5% |
| 4 | 20 | 30 | 20 | 1.92 | 38.1% |
| 5 | 10 | 30 | 35 | 1.88 | 44.6% |

**使用建议:**
- 选择 **Top 1** 最保守
- 如果 Top 3 参数相近 → 参数稳健
- 如果 Top 5 参数差异大 → 不稳定，谨慎

---

## 四、常见问题

### Q1: "❌ 未找到有效的参数组合"

**可能原因:**

1. **数据不足**
   - 解决: 扩大日期范围到 3-5年

2. **参数范围不合理**
   - 解决: 扩大参数范围
   ```
   止损: 5%-35% (步长5%)
   止盈: 10%-50% (步长5%)
   仓位: 10%-50% (步长10%)
   ```

3. **股票不适合该策略**
   - 解决: 换股票测试（选择大盘蓝筹）

4. **策略本身不盈利**
   - 解决: 查看回测结果，可能该策略不适合当前市场

---

### Q2: 优化时间太长怎么办？

**优化方法:**

1. **减少组合数**
   ```
   方案1: 增大步长
   止损: 5%, 15%, 25%  (步长10% → 3个值)
   止盈: 10%, 20%, 30%, 40%  (步长10% → 4个值)
   仓位: 20%, 40%  (步长20% → 2个值)

   总组合: 3 × 4 × 2 = 24 种 (快速验证)
   ```

2. **缩小参数范围**
   ```
   方案2: 聚焦核心区域
   止损: 10%-20% (步长5%)
   止盈: 20%-35% (步长5%)
   仓位: 20%-40% (步长10%)
   ```

3. **缩短数据周期**
   - 从 5年缩短到 3年（但会降低验证可靠性）

---

### Q3: 如何选择优化目标？

**三种优化目标:**

| 目标 | 适用场景 | 特点 |
|------|---------|------|
| **夏普比率** | 大多数情况 | 平衡收益与风险 ✅ 推荐 |
| **总收益率** | 追求高收益 | 可能承受更大回撤 |
| **Sortino比率** | 厌恶下行风险 | 只考虑负向波动 |

**推荐**: 使用 **夏普比率** 作为默认目标。

---

### Q4: 过拟合怎么办？

**如果测试集表现差 (Sharpe差距 > 1.0):**

1. **增加数据长度**
   - 从 3年扩展到 5-7年

2. **使用更保守的参数**
   - 选择 Top 5 中最保守的组合

3. **降低仓位**
   - 将推荐仓位减半（如 30% → 15%）

4. **简化策略**
   - 减少策略参数数量
   - 避免过度优化

---

## 五、最佳实践

### ✅ 推荐做法

1. **多股票验证**
   ```
   在3-5只不同股票上测试相同策略
   如果最优参数相似 → 参数稳健
   ```

2. **分批测试**
   ```
   第一轮: 粗网格搜索（步长10%）→ 找到大致区域
   第二轮: 细网格搜索（步长2%）→ 精确优化
   ```

3. **记录优化历史**
   ```
   每次优化后保存结果
   定期回顾（如每季度）
   观察参数是否需要调整
   ```

4. **实盘验证**
   ```
   优化完成后，先用模拟盘测试1-3个月
   确认实盘表现接近回测 → 再上实盘
   ```

---

### ❌ 避免的错误

1. **过度优化**
   - 不要测试太多参数组合 (> 1000)
   - 避免"调参调到完美" → 必然过拟合

2. **忽略前推验证**
   - 必须启用前推验证
   - 不要只看训练集性能

3. **选择不当的股票**
   - 避免小盘股、ST股
   - 避免数据缺失的股票

4. **过度依赖历史数据**
   - 历史表现 ≠ 未来表现
   - 市场环境会变化

---

## 六、实战案例

### 案例: 优化茅台的120日均线策略

**配置:**
```yaml
股票代码: 600519.SH (贵州茅台)
策略: ma_breakout_120
日期范围: 2018-01-01 至 2023-12-31 (6年)
初始资金: ¥100,000

参数范围:
  止损: 5% - 30% (步长5%) → 6个值
  止盈: 10% - 40% (步长5%) → 7个值
  仓位: 20% - 50% (步长10%) → 4个值

总组合: 6 × 7 × 4 = 168 种
```

**优化结果:**
```
🏆 最优参数组合:
- 止损: 10%
- 止盈: 35%
- 仓位: 30%

回测表现 (2018-2023):
- 总收益率: 127.5%
- 夏普比率: 1.92
- 最大回撤: -22.8%
- 胜率: 61.2%
- 总交易次数: 18次

前推验证:
- 训练集 Sharpe: 2.05 (2018-2020)
- 测试集 Sharpe: 1.78 (2021-2023)
- Sharpe差距: 0.27 ✅ 参数稳健
```

**结论:**
- ✅ 参数通过前推验证
- ✅ 风险收益比合理
- ✅ 可应用于实盘（建议仓位减半至15%）

---

## 七、下一步

完成参数优化后，可以:

1. **📋 保存结果** → 保存到数据库
2. **✓ 应用参数** → 更新策略配置
3. **🔙 返回回测** → 用最优参数完整回测
4. **📊 实盘验证** → 模拟盘测试1-3个月

---

## 八、技术细节

### 网格搜索算法

```python
for stop_loss in [5, 10, 15, 20, 25]:
    for take_profit in [10, 20, 30, 40]:
        for position in [20, 30, 40]:
            # 运行回测
            result = backtest(stop_loss, take_profit, position)
            # 记录结果
            results.append(result)

# 按夏普比率排序
best_params = sorted(results, key=lambda x: x.sharpe_ratio)[0]
```

### 前推验证流程

```
完整数据: 2018-2023 (6年)

Window 1:
├─ 训练: 2018-2020 (2年) → 找最优参数
└─ 测试: 2020-2021 (1年) → 验证性能

Window 2:
├─ 训练: 2019-2021 (2年) → 找最优参数
└─ 测试: 2021-2022 (1年) → 验证性能

Window 3:
├─ 训练: 2020-2022 (2年) → 找最优参数
└─ 测试: 2022-2023 (1年) → 验证性能

如果3个窗口的参数都相近 → 参数非常稳健
```

---

## 需要帮助？

- 📖 查看策略文档: `/docs/strategies/`
- 💬 提问: 在 GitHub Issues 提问
- 📧 联系: 查看项目 README

**祝优化顺利！** 🎉
