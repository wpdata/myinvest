# MyInvest V0.3 新功能详解

本文档详细介绍V0.3版本的两个核心新功能：**组合策略构建器**和**策略推荐系统**，以及**监视列表**的使用场景。

---

## 1. 组合策略构建器（Combinations）

### 功能概述
组合策略构建器用于构建和分析**多腿期权/期货组合策略**，帮助投资者设计复杂的衍生品交易策略并可视化其盈亏特征。

### 核心概念

#### 什么是组合策略？
组合策略是由多个合约（腿）组成的复杂交易结构，通过同时买入/卖出不同行权价、到期日的期权或期货合约，实现特定的风险收益特征。

**示例：备兑开仓（Covered Call）**
- **腿1**：持有100股股票（做多）
- **腿2**：卖出1张看涨期权（做空call）
- **目的**：在持有股票的同时，通过卖出期权获取权利金收入，降低持仓成本

### 支持的策略模板

#### 1. 备兑开仓（Covered Call）
**适用场景**：持有股票，预期短期小幅上涨或横盘
**构成**：
- 持有现货股票（100股）
- 卖出1张虚值看涨期权

**盈亏特征**：
- 最大收益：权利金 + (行权价 - 买入价) × 股数
- 最大亏损：买入成本 - 权利金（如果股价大跌）
- 盈亏平衡点：买入价 - 权利金

**使用步骤**：
1. 选择"备兑开仓"模板
2. 输入股票代码（可从持仓选择或手动输入）
3. 设置股票价格和数量
4. 设置期权行权价（建议比当前价高5-10%）
5. 输入期权权利金
6. 选择到期日
7. 点击"生成策略"查看盈亏曲线

**示例**：
```
持有贵州茅台 600519.SH
- 股票价格：¥1800
- 持有数量：100股
- 卖出行权价 ¥1900 的看涨期权
- 权利金：¥50/股
- 到期日：30天后

最大收益：50×100 + (1900-1800)×100 = ¥15,000
盈亏平衡：1800 - 50 = ¥1750
```

#### 2. 蝶式价差（Butterfly Spread）
**适用场景**：预期标的价格在到期时接近某个特定价格（ATM）
**构成**：
- 买入1张低行权价期权
- 卖出2张中间行权价期权（ATM）
- 买入1张高行权价期权

**盈亏特征**：
- 最大收益：当到期价格等于中间行权价时
- 最大亏损：净付出的权利金
- 风险有限，收益有限

**使用步骤**：
1. 选择"蝶式价差"模板
2. 选择标的（如50ETF）
3. 选择期权类型（认购/认沽）
4. 设置三个行权价（下/中/上）
5. 输入各行权价对应的权利金
6. 查看对称的蝶式盈亏曲线

**示例**：
```
标的：50ETF，当前价 ¥3.0
- 买入行权价 2.8 call，权利金 0.15
- 卖出2张行权价 3.0 call，权利金 0.10×2
- 买入行权价 3.2 call，权利金 0.05

净成本：0.15 - 0.20 + 0.05 = 0
最大收益：0.2（当到期价=3.0时）
```

#### 3. 跨式组合（Straddle）
**适用场景**：预期标的价格将大幅波动，但方向不确定
**构成**：
- 同时买入同一行权价的看涨和看跌期权

**盈亏特征**：
- 最大收益：无限（价格大涨或大跌）
- 最大亏损：支付的总权利金
- 需要较大的价格波动才能盈利

#### 4. 牛市看涨价差（Bull Call Spread）
**适用场景**：预期标的价格温和上涨
**构成**：
- 买入低行权价看涨期权
- 卖出高行权价看涨期权

**盈亏特征**：
- 最大收益：(高行权价 - 低行权价) - 净权利金
- 最大亏损：净权利金
- 降低了买入单腿call的成本

### 保证金计算
系统会根据组合策略自动计算所需保证金：
- 单腿策略：按标准公式
- 组合策略：考虑对冲效应，通常低于单腿保证金之和

### 盈亏曲线可视化
- **X轴**：到期时标的价格
- **Y轴**：策略总盈亏
- **曲线**：显示不同价格下的盈亏情况
- **关键点**：盈亏平衡点、最大收益、最大亏损

---

## 2. 策略推荐系统（Recommendations）

### 功能概述
策略推荐系统基于**多时间框架分析**（Multi-Timeframe Analysis），结合周线趋势和日线信号，为用户提供更可靠的交易建议。

### 核心理念：多时间框架分析

#### 为什么需要多时间框架？
单一时间框架容易产生虚假信号：
- **只看日线**：可能在周线下跌趋势中频繁抄底，导致连续亏损
- **只看周线**：入场时机不够精确，错过最佳买点

**多时间框架解决方案**：
- **周线**：判断主趋势（上升/下降/横盘）
- **日线**：寻找精确入场点
- **原则**：只在周线趋势向上时，才接受日线的买入信号

### 分析模式

#### 模式1：日线分析（Daily）
仅使用日线数据进行技术分析。

**指标**：
- 5日均线（MA5）
- 20日均线（MA20）

**信号规则**：
- **买入**：MA5 > MA20 且 价格 > MA5
- **卖出**：MA5 < MA20 且 价格 < MA5
- **观望**：其他情况

**适用场景**：
- 短线交易
- 波段操作
- 快速响应市场变化

#### 模式2：周线分析（Weekly）
仅使用周线数据判断趋势。

**指标**：
- 10周均线（MA10）
- 20周均线（MA20）

**趋势判断**：
- **上升趋势**：MA10 > MA20
- **下降趋势**：MA10 < MA20
- **横盘震荡**：MA10 ≈ MA20

**适用场景**：
- 中长期投资
- 趋势跟踪
- 避免短期噪音

#### 模式3：日线+周线组合（Multi-TF）**【推荐】**
这是**核心功能**，结合两个时间框架的优势。

**分析流程**：
1. **第一步：周线趋势确认**
   - 计算周线均线
   - 判断主趋势方向

2. **第二步：日线信号筛选**
   - 在日线上寻找买卖信号
   - **关键**：只有当周线趋势匹配时才发出信号

3. **第三步：信号融合**
   - 周线上升 + 日线买入 → **强烈买入**
   - 周线下降 + 日线卖出 → **强烈卖出**
   - 周线与日线矛盾 → **观望**

**信号逻辑表**：
```
周线趋势 | 日线信号 | 最终推荐
---------|----------|----------
上升     | 买入     | ✅ 强烈买入
上升     | 卖出     | ⏸️ 观望（趋势未破坏）
下降     | 买入     | ⏸️ 观望（反弹抄底风险大）
下降     | 卖出     | ⚠️ 强烈卖出
横盘     | 买入     | 🔶 谨慎买入
横盘     | 卖出     | 🔶 谨慎卖出
```

### 使用步骤

1. **选择标的**：
   - 从持仓列表选择已有股票，或
   - 手动输入新的股票代码

2. **选择时间框架**：
   - 推荐选择"日线+周线组合"

3. **点击分析**：
   系统将：
   - 自动获取2年历史数据
   - 计算周线和日线指标
   - 生成多时间框架分析报告

4. **查看结果**：
   - **周线趋势**：显示当前主趋势
   - **日线信号**：显示短期买卖信号
   - **综合推荐**：最终交易建议
   - **推理说明**：解释信号来源

### 实际案例

**案例：贵州茅台（600519.SH）**

假设当前市场状态：
- **周线**：10周均线在20周均线上方（上升趋势）
- **日线**：价格突破5日均线，且5日均线上穿20日均线

**系统分析**：
```
📊 周线分析：
- 10周均线：¥1850
- 20周均线：¥1780
- 趋势：🟢 上升

📅 日线分析：
- 5日均线：¥1820
- 20日均线：¥1800
- 当前价：¥1825
- 信号：🟢 买入

🎯 综合推荐：✅ 强烈买入
📝 推理：周线上升趋势确认，日线突破信号出现，
        形成多时间框架共振，建议建仓或加仓。
```

---

## 3. 监视列表（Watchlist）使用场景

### 当前功能
监视列表在V0.2版本中是一个**数据管理模块**，用于：
1. 录入和管理关注的股票代码
2. 快速查看多只股票的实时价格
3. 标记重点关注的品种

### 实际应用场景

#### 场景1：调度器自动分析
**位置**：`investapp/scheduler/daily_tasks.py`

**功能**：每日定时任务会：
1. 从监视列表获取所有股票代码
2. 对每只股票运行已批准的策略
3. 生成策略推荐报告
4. 发送通知（如有信号）

**代码逻辑**：
```python
def generate_daily_recommendations(self):
    # 获取监视列表股票
    watchlist = self._get_watchlist_symbols()

    # 对每只股票分析
    for symbol in watchlist:
        # 运行各种策略
        kroll_signal = run_kroll_strategy(symbol)
        livermore_signal = run_livermore_strategy(symbol)

        # 生成推荐
        if kroll_signal == 'BUY' or livermore_signal == 'BUY':
            save_recommendation(symbol, 'BUY', ...)
```

**使用方法**：
1. 在"监视列表"页面添加股票
2. 系统每日自动对这些股票进行策略分析
3. 在"仪表盘"查看生成的推荐

#### 场景2：标的快速选择
在以下页面中，标的选择器会优先显示监视列表中的股票：
- ✅ 策略回测
- ✅ 策略推荐
- ✅ 组合策略
- ✅ 轮动策略

**优势**：
- 不需要每次手动输入代码
- 快速切换关注的股票
- 减少输入错误

#### 场景3：批量监控（未来规划）
V0.3+版本将增强监视列表功能：
- 批量查看所有监视股票的技术指标
- 筛选出符合特定条件的股票
- 对比多只股票的表现

### 监视列表 vs 持仓记录

| 特性 | 监视列表 | 持仓记录 |
|------|----------|----------|
| 用途 | 关注但未买入的股票 | 实际持有的股票 |
| 数据表 | `watchlist` | `current_holdings` |
| 数量 | 需要输入 | 自动从交易记录计算 |
| 成本价 | 无 | 有 |
| 盈亏 | 无 | 有 |
| 用于调度器 | ✅ 是 | ❌ 否 |
| 用于快速选择 | ✅ 是 | ✅ 是 |

**建议用法**：
- **监视列表**：放入潜在买入目标，让系统每天自动分析
- **持仓记录**：放入已买入股票，用于盈亏跟踪

### 完整工作流程示例

**步骤1：建立监视列表**
```
监视列表添加：
- 600519.SH（茅台）
- 000858.SZ（五粮液）
- 600809.SH（山西汾酒）
```

**步骤2：每日自动分析**
```
系统每晚定时：
- 获取3只股票的最新数据
- 运行Kroll、Livermore策略
- 检测到：600519.SH 有买入信号
- 保存推荐到数据库
```

**步骤3：查看推荐**
```
次日打开仪表盘：
- 看到推荐卡片：
  "600519.SH - Livermore策略 - 买入信号"
- 查看详细推理
- 决定是否执行
```

**步骤4：快速回测验证**
```
进入策略回测页面：
- 标的选择器自动显示监视列表
- 选择 600519.SH
- 运行Livermore策略回测
- 查看历史胜率和盈亏曲线
- 确认策略有效性
```

**步骤5：执行交易**
```
如果决定买入：
- 在"持仓记录"页面录入交易
- 买入价、数量、手续费
- 系统自动计算成本价
- 从此可在Dashboard看到实时盈亏
```

---

## 总结

### 组合策略构建器
- **用途**：设计复杂期权组合，可视化盈亏
- **适合**：期权交易者、风险对冲需求
- **核心**：多腿策略模板 + 保证金计算 + 盈亏曲线

### 策略推荐系统
- **用途**：生成高质量交易信号
- **适合**：所有投资者
- **核心**：多时间框架分析 + 趋势过滤 + 信号融合

### 监视列表
- **用途**：管理关注股票 + 自动化分析
- **适合**：主动跟踪多只股票的投资者
- **核心**：调度器集成 + 快速选择 + 批量监控

### 最佳实践

1. **新手用户**：
   - 先用"策略推荐"的日线模式熟悉系统
   - 添加3-5只股票到监视列表
   - 每天查看自动生成的推荐

2. **进阶用户**：
   - 使用"多时间框架"模式提高胜率
   - 结合策略回测验证信号
   - 根据推荐执行交易并记录持仓

3. **期权交易者**：
   - 使用组合策略构建器设计复杂策略
   - 计算保证金需求
   - 可视化风险收益特征

### 功能协同
```
监视列表 → 自动分析 → 策略推荐 → 回测验证 → 执行交易 → 持仓跟踪
    ↓          ↓           ↓           ↓           ↓          ↓
  关注品种   定时任务    信号生成    历史验证    买入股票   盈亏监控
```

整个系统形成了一个完整的**交易决策支持闭环**。
