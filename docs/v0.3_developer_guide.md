# MyInvest V0.3 开发者文档

**版本**: V0.3
**更新**: 2025-10-24
**目标读者**: 开发者、贡献者

---

## 📐 架构概览

### 系统架构

```
myinvest/
├── investlib-data/        # 数据层 (市场数据、数据库)
├── investlib-quant/       # 量化层 (策略、指标)
├── investlib-backtest/    # 回测引擎
├── investlib-optimizer/   # 参数优化
├── investlib-export/      # 报告导出
├── investlib-margin/      # 保证金计算
├── investlib-greeks/      # 期权Greeks
├── investlib-risk/        # 风险管理
└── investapp/             # Streamlit UI
```

### 技术栈

- **语言**: Python 3.10+
- **UI**: Streamlit
- **数据库**: SQLite (SQLAlchemy ORM)
- **数据源**: efinance, AkShare
- **回测**: Pandas, NumPy
- **并行**: multiprocessing, SharedMemory
- **导出**: ReportLab (PDF), openpyxl (Excel), python-docx (Word)

---

## 🗄️ 数据库架构

### 核心表结构

#### watchlist (监视列表)
```sql
CREATE TABLE watchlist (
    id INTEGER PRIMARY KEY,
    symbol VARCHAR(20) NOT NULL UNIQUE,
    group_name VARCHAR(50) DEFAULT 'default',
    contract_type VARCHAR(10) DEFAULT 'stock',  -- stock/futures/option
    status VARCHAR(10) DEFAULT 'active',
    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### contract_info (合约信息)
```sql
CREATE TABLE contract_info (
    id INTEGER PRIMARY KEY,
    symbol VARCHAR(20) NOT NULL UNIQUE,
    name VARCHAR(100),
    asset_type VARCHAR(10),  -- stock/futures/option
    exchange VARCHAR(20),
    multiplier INTEGER DEFAULT 1,
    margin_rate FLOAT DEFAULT 0.15,
    expiry_date DATE
);
```

### 数据库迁移

使用 Alembic 管理迁移：

```bash
# 创建新迁移
alembic revision -m "add_new_column"

# 应用迁移
alembic upgrade head

# 回退
alembic downgrade -1
```

---

## 🔧 添加新策略

### 1. 创建策略类

```python
# investlib-quant/src/investlib_quant/strategies/my_strategy.py

from ..base import StockStrategy
import pandas as pd

class MyStrategy(StockStrategy):
    """我的自定义策略"""

    def __init__(self, name: str = "我的策略", param1: int = 10):
        super().__init__(name)
        self.param1 = param1

    def generate_signal(self, market_data: pd.DataFrame):
        # 验证数据
        if not self.validate_data(market_data, required_rows=20):
            return None

        # 计算指标
        ma = market_data['close'].rolling(self.param1).mean()

        # 生成信号
        current_price = market_data['close'].iloc[-1]
        if current_price > ma.iloc[-1]:
            return {
                'action': 'BUY',
                'entry_price': current_price,
                'stop_loss': current_price * 0.95,
                'take_profit': current_price * 1.10,
                'position_size_pct': 0.5,
                'confidence': 'MEDIUM',
                'reasoning': {'indicator': 'MA', 'value': ma.iloc[-1]}
            }

        return None
```

### 2. 注册到UI

```python
# investapp/investapp/pages/6_策略回测_Backtest.py

strategy_options = {
    "Livermore策略": LivermoreStrategy,
    "Kroll策略": KrollStrategy,
    "我的策略": MyStrategy  # 添加这行
}
```

### 3. 编写测试

```python
# tests/unit/test_my_strategy.py

import pytest
from investlib_quant.strategies.my_strategy import MyStrategy

def test_my_strategy_buy_signal():
    strategy = MyStrategy(param1=10)
    # ... 测试代码
```

---

## ⚙️ 配置管理

### 环境变量 (.env)

```bash
# 数据库
DATABASE_URL=sqlite:////Users/pw/ai/myinvest/data/myinvest.db

# API配置
EFINANCE_TIMEOUT=30
AKSHARE_TIMEOUT=30

# 期货配置
DEFAULT_MARGIN_RATE=0.15
FORCE_CLOSE_MARGIN_RATE=0.10

# 期权配置
RISK_FREE_RATE=0.03
DEFAULT_VOLATILITY=0.20
```

### Pydantic 配置验证

```python
# investlib-data/src/investlib_data/config.py

from pydantic import BaseSettings, validator

class Settings(BaseSettings):
    database_url: str
    default_margin_rate: float = 0.15
    force_close_margin_rate: float = 0.10

    @validator('force_close_margin_rate')
    def validate_force_close(cls, v, values):
        if 'default_margin_rate' in values:
            if v >= values['default_margin_rate']:
                raise ValueError(
                    "force_close_margin_rate must be < default_margin_rate"
                )
        return v

    class Config:
        env_file = '.env'
```

---

## 🚀 性能优化

### 并行回测

使用 SharedMemory 缓存避免重复数据加载：

```python
from investlib_backtest.cache.shared_memory import SharedMemoryCache

cache = SharedMemoryCache(max_size_mb=500)

# 预加载数据
cache.put("600519.SH", market_data)

# 并行回测时，所有进程共享数据
results = parallel_backtest(symbols, strategy, cache=cache)
```

### API 响应缓存

```python
# investlib-data/src/investlib_data/cache.py

from functools import lru_cache
import time

class TTLCache:
    def __init__(self, ttl_seconds=300):
        self.cache = {}
        self.ttl = ttl_seconds

    def get(self, key):
        if key in self.cache:
            data, timestamp = self.cache[key]
            if time.time() - timestamp < self.ttl:
                return data
        return None

    def put(self, key, value):
        self.cache[key] = (value, time.time())
```

### 内存优化

```python
# 使用生成器减少内存占用
def process_large_dataset(df):
    for chunk in pd.read_csv('data.csv', chunksize=10000):
        yield process_chunk(chunk)

# 及时释放大对象
del large_dataframe
import gc
gc.collect()
```

---

## 🧪 测试指南

### 单元测试

```python
# tests/unit/test_margin_calculator.py

import pytest
from investlib_margin.calculator import MarginCalculator

def test_margin_calculation():
    calc = MarginCalculator()
    margin = calc.calculate_margin(
        contract_type='futures',
        quantity=1,
        price=4000,
        multiplier=300,
        margin_rate=0.15
    )
    assert margin == 180000  # 4000 * 300 * 0.15
```

### 集成测试

```python
# tests/integration/test_backtest_pipeline.py

def test_full_backtest_pipeline():
    # 1. 添加到监视列表
    watchlist_db.add_symbol("600519.SH", "test")

    # 2. 获取市场数据
    fetcher = MarketDataFetcher()
    data = fetcher.fetch_with_fallback("600519.SH", "2024-01-01", "2024-12-31")

    # 3. 运行回测
    engine = BacktestEngine()
    result = engine.run(strategy, data)

    # 4. 验证结果
    assert result['final_equity'] > 0
    assert 'trades' in result
```

### 运行测试

```bash
# 运行所有测试
pytest

# 运行特定测试
pytest tests/unit/test_margin_calculator.py

# 带覆盖率报告
pytest --cov=investlib_quant --cov-report=html
```

---

## 📊 日志配置

### 配置日志

```python
import logging

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('logs/myinvest.log'),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger(__name__)
```

### 使用日志

```python
logger.info("开始回测: 600519.SH")
logger.warning("数据缺失: 2024-01-01")
logger.error("API调用失败: efinance timeout")
```

---

## 🌐 国际化 (i18n)

### 中文优先原则

**Constitution Principle I**: All user-facing text MUST be Chinese-first

```python
# ✅ 正确
st.title("策略回测")
st.button("开始回测")

# ❌ 错误
st.title("Strategy Backtest")
st.button("Start Backtest")
```

### 本地化函数

```python
# investapp/locales/__init__.py

TRANSLATIONS = {
    "backtest.title": "策略回测",
    "backtest.start_button": "开始回测",
    "backtest.status.running": "回测进行中...",
}

def _(key: str) -> str:
    return TRANSLATIONS.get(key, key)
```

---

## 🔌 扩展点

### 添加新数据源

```python
# investlib-data/src/investlib_data/sources/new_source.py

class NewSourceClient:
    def fetch_daily_data(self, symbol, start_date, end_date):
        # 实现数据获取逻辑
        return pd.DataFrame(...)

# 注册到 MarketDataFetcher
fetcher.add_source('newsource', NewSourceClient())
```

### 添加新指标

```python
# investlib-quant/src/investlib_quant/indicators/my_indicator.py

def calculate_my_indicator(df, period=14):
    # 计算指标
    return indicator_series
```

### 添加新导出格式

```python
# investlib-export/src/investlib_export/json_generator.py

class JSONGenerator:
    def generate(self, backtest_result):
        return json.dumps(backtest_result, indent=2)
```

---

## 🐛 调试技巧

### Streamlit 调试

```python
# 显示数据框供调试
st.write("Debug data:", df)

# 显示变量
st.json({'var1': var1, 'var2': var2})

# 使用 st.expander 折叠调试信息
with st.expander("调试信息"):
    st.write(debug_data)
```

### 性能分析

```python
import cProfile
import pstats

profiler = cProfile.Profile()
profiler.enable()

# 你的代码
run_backtest()

profiler.disable()
stats = pstats.Stats(profiler)
stats.sort_stats('cumulative')
stats.print_stats(20)
```

---

## 📦 发布流程

### 版本号规则

- **Major.Minor.Patch** (例如：0.3.0)
- Major: 不兼容更新
- Minor: 新功能
- Patch: Bug修复

### 发布清单

- [ ] 所有测试通过
- [ ] 更新 CHANGELOG.md
- [ ] 更新版本号
- [ ] 创建 Git tag
- [ ] 构建文档
- [ ] 发布到 PyPI (如需要)

```bash
# 打标签
git tag -a v0.3.0 -m "Release V0.3: Production-Ready Enhancement"
git push origin v0.3.0
```

---

## 🤝 贡献指南

### 代码规范

- 遵循 PEP 8
- 使用类型提示
- 编写文档字符串
- 中文优先原则

### Pull Request 流程

1. Fork 仓库
2. 创建功能分支: `git checkout -b feature/my-feature`
3. 提交更改: `git commit -m "feat: add new indicator"`
4. 推送分支: `git push origin feature/my-feature`
5. 创建 Pull Request

### Commit 信息规范

```
feat: 新功能
fix: Bug修复
docs: 文档更新
test: 测试相关
refactor: 代码重构
perf: 性能优化
chore: 构建/工具更新
```

---

## 📚 参考资源

- **Streamlit 文档**: https://docs.streamlit.io
- **Pandas 文档**: https://pandas.pydata.org
- **SQLAlchemy 文档**: https://docs.sqlalchemy.org
- **efinance 文档**: https://github.com/cj-efinance/efinance
- **AkShare 文档**: https://akshare.akfamily.xyz

---

**最后更新**: 2025-10-24
**维护者**: MyInvest Team
