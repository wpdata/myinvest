# MyInvest V0.3 å¼€å‘è€…æ–‡æ¡£

**ç‰ˆæœ¬**: V0.3
**æ›´æ–°**: 2025-10-24
**ç›®æ ‡è¯»è€…**: å¼€å‘è€…ã€è´¡çŒ®è€…

---

## ğŸ“ æ¶æ„æ¦‚è§ˆ

### ç³»ç»Ÿæ¶æ„

```
myinvest/
â”œâ”€â”€ investlib-data/        # æ•°æ®å±‚ (å¸‚åœºæ•°æ®ã€æ•°æ®åº“)
â”œâ”€â”€ investlib-quant/       # é‡åŒ–å±‚ (ç­–ç•¥ã€æŒ‡æ ‡)
â”œâ”€â”€ investlib-backtest/    # å›æµ‹å¼•æ“
â”œâ”€â”€ investlib-optimizer/   # å‚æ•°ä¼˜åŒ–
â”œâ”€â”€ investlib-export/      # æŠ¥å‘Šå¯¼å‡º
â”œâ”€â”€ investlib-margin/      # ä¿è¯é‡‘è®¡ç®—
â”œâ”€â”€ investlib-greeks/      # æœŸæƒGreeks
â”œâ”€â”€ investlib-risk/        # é£é™©ç®¡ç†
â””â”€â”€ investapp/             # Streamlit UI
```

### æŠ€æœ¯æ ˆ

- **è¯­è¨€**: Python 3.10+
- **UI**: Streamlit
- **æ•°æ®åº“**: SQLite (SQLAlchemy ORM)
- **æ•°æ®æº**: efinance, AkShare
- **å›æµ‹**: Pandas, NumPy
- **å¹¶è¡Œ**: multiprocessing, SharedMemory
- **å¯¼å‡º**: ReportLab (PDF), openpyxl (Excel), python-docx (Word)

---

## ğŸ—„ï¸ æ•°æ®åº“æ¶æ„

### æ ¸å¿ƒè¡¨ç»“æ„

#### watchlist (ç›‘è§†åˆ—è¡¨)
```sql
CREATE TABLE watchlist (
    id INTEGER PRIMARY KEY,
    symbol VARCHAR(20) NOT NULL UNIQUE,
    group_name VARCHAR(50) DEFAULT 'default',
    contract_type VARCHAR(10) DEFAULT 'stock',  -- stock/futures/option
    status VARCHAR(10) DEFAULT 'active',
    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### contract_info (åˆçº¦ä¿¡æ¯)
```sql
CREATE TABLE contract_info (
    id INTEGER PRIMARY KEY,
    symbol VARCHAR(20) NOT NULL UNIQUE,
    name VARCHAR(100),
    asset_type VARCHAR(10),  -- stock/futures/option
    exchange VARCHAR(20),
    multiplier INTEGER DEFAULT 1,
    margin_rate FLOAT DEFAULT 0.15,
    expiry_date DATE
);
```

### æ•°æ®åº“è¿ç§»

ä½¿ç”¨ Alembic ç®¡ç†è¿ç§»ï¼š

```bash
# åˆ›å»ºæ–°è¿ç§»
alembic revision -m "add_new_column"

# åº”ç”¨è¿ç§»
alembic upgrade head

# å›é€€
alembic downgrade -1
```

---

## ğŸ”§ æ·»åŠ æ–°ç­–ç•¥

### 1. åˆ›å»ºç­–ç•¥ç±»

```python
# investlib-quant/src/investlib_quant/strategies/my_strategy.py

from ..base import StockStrategy
import pandas as pd

class MyStrategy(StockStrategy):
    """æˆ‘çš„è‡ªå®šä¹‰ç­–ç•¥"""

    def __init__(self, name: str = "æˆ‘çš„ç­–ç•¥", param1: int = 10):
        super().__init__(name)
        self.param1 = param1

    def generate_signal(self, market_data: pd.DataFrame):
        # éªŒè¯æ•°æ®
        if not self.validate_data(market_data, required_rows=20):
            return None

        # è®¡ç®—æŒ‡æ ‡
        ma = market_data['close'].rolling(self.param1).mean()

        # ç”Ÿæˆä¿¡å·
        current_price = market_data['close'].iloc[-1]
        if current_price > ma.iloc[-1]:
            return {
                'action': 'BUY',
                'entry_price': current_price,
                'stop_loss': current_price * 0.95,
                'take_profit': current_price * 1.10,
                'position_size_pct': 0.5,
                'confidence': 'MEDIUM',
                'reasoning': {'indicator': 'MA', 'value': ma.iloc[-1]}
            }

        return None
```

### 2. æ³¨å†Œåˆ°UI

```python
# investapp/investapp/pages/6_ç­–ç•¥å›æµ‹_Backtest.py

strategy_options = {
    "Livermoreç­–ç•¥": LivermoreStrategy,
    "Krollç­–ç•¥": KrollStrategy,
    "æˆ‘çš„ç­–ç•¥": MyStrategy  # æ·»åŠ è¿™è¡Œ
}
```

### 3. ç¼–å†™æµ‹è¯•

```python
# tests/unit/test_my_strategy.py

import pytest
from investlib_quant.strategies.my_strategy import MyStrategy

def test_my_strategy_buy_signal():
    strategy = MyStrategy(param1=10)
    # ... æµ‹è¯•ä»£ç 
```

---

## âš™ï¸ é…ç½®ç®¡ç†

### ç¯å¢ƒå˜é‡ (.env)

```bash
# æ•°æ®åº“
DATABASE_URL=sqlite:////Users/pw/ai/myinvest/data/myinvest.db

# APIé…ç½®
EFINANCE_TIMEOUT=30
AKSHARE_TIMEOUT=30

# æœŸè´§é…ç½®
DEFAULT_MARGIN_RATE=0.15
FORCE_CLOSE_MARGIN_RATE=0.10

# æœŸæƒé…ç½®
RISK_FREE_RATE=0.03
DEFAULT_VOLATILITY=0.20
```

### Pydantic é…ç½®éªŒè¯

```python
# investlib-data/src/investlib_data/config.py

from pydantic import BaseSettings, validator

class Settings(BaseSettings):
    database_url: str
    default_margin_rate: float = 0.15
    force_close_margin_rate: float = 0.10

    @validator('force_close_margin_rate')
    def validate_force_close(cls, v, values):
        if 'default_margin_rate' in values:
            if v >= values['default_margin_rate']:
                raise ValueError(
                    "force_close_margin_rate must be < default_margin_rate"
                )
        return v

    class Config:
        env_file = '.env'
```

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### å¹¶è¡Œå›æµ‹

ä½¿ç”¨ SharedMemory ç¼“å­˜é¿å…é‡å¤æ•°æ®åŠ è½½ï¼š

```python
from investlib_backtest.cache.shared_memory import SharedMemoryCache

cache = SharedMemoryCache(max_size_mb=500)

# é¢„åŠ è½½æ•°æ®
cache.put("600519.SH", market_data)

# å¹¶è¡Œå›æµ‹æ—¶ï¼Œæ‰€æœ‰è¿›ç¨‹å…±äº«æ•°æ®
results = parallel_backtest(symbols, strategy, cache=cache)
```

### API å“åº”ç¼“å­˜

```python
# investlib-data/src/investlib_data/cache.py

from functools import lru_cache
import time

class TTLCache:
    def __init__(self, ttl_seconds=300):
        self.cache = {}
        self.ttl = ttl_seconds

    def get(self, key):
        if key in self.cache:
            data, timestamp = self.cache[key]
            if time.time() - timestamp < self.ttl:
                return data
        return None

    def put(self, key, value):
        self.cache[key] = (value, time.time())
```

### å†…å­˜ä¼˜åŒ–

```python
# ä½¿ç”¨ç”Ÿæˆå™¨å‡å°‘å†…å­˜å ç”¨
def process_large_dataset(df):
    for chunk in pd.read_csv('data.csv', chunksize=10000):
        yield process_chunk(chunk)

# åŠæ—¶é‡Šæ”¾å¤§å¯¹è±¡
del large_dataframe
import gc
gc.collect()
```

---

## ğŸ§ª æµ‹è¯•æŒ‡å—

### å•å…ƒæµ‹è¯•

```python
# tests/unit/test_margin_calculator.py

import pytest
from investlib_margin.calculator import MarginCalculator

def test_margin_calculation():
    calc = MarginCalculator()
    margin = calc.calculate_margin(
        contract_type='futures',
        quantity=1,
        price=4000,
        multiplier=300,
        margin_rate=0.15
    )
    assert margin == 180000  # 4000 * 300 * 0.15
```

### é›†æˆæµ‹è¯•

```python
# tests/integration/test_backtest_pipeline.py

def test_full_backtest_pipeline():
    # 1. æ·»åŠ åˆ°ç›‘è§†åˆ—è¡¨
    watchlist_db.add_symbol("600519.SH", "test")

    # 2. è·å–å¸‚åœºæ•°æ®
    fetcher = MarketDataFetcher()
    data = fetcher.fetch_with_fallback("600519.SH", "2024-01-01", "2024-12-31")

    # 3. è¿è¡Œå›æµ‹
    engine = BacktestEngine()
    result = engine.run(strategy, data)

    # 4. éªŒè¯ç»“æœ
    assert result['final_equity'] > 0
    assert 'trades' in result
```

### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest

# è¿è¡Œç‰¹å®šæµ‹è¯•
pytest tests/unit/test_margin_calculator.py

# å¸¦è¦†ç›–ç‡æŠ¥å‘Š
pytest --cov=investlib_quant --cov-report=html
```

---

## ğŸ“Š æ—¥å¿—é…ç½®

### é…ç½®æ—¥å¿—

```python
import logging

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('logs/myinvest.log'),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger(__name__)
```

### ä½¿ç”¨æ—¥å¿—

```python
logger.info("å¼€å§‹å›æµ‹: 600519.SH")
logger.warning("æ•°æ®ç¼ºå¤±: 2024-01-01")
logger.error("APIè°ƒç”¨å¤±è´¥: efinance timeout")
```

---

## ğŸŒ å›½é™…åŒ– (i18n)

### ä¸­æ–‡ä¼˜å…ˆåŸåˆ™

**Constitution Principle I**: All user-facing text MUST be Chinese-first

```python
# âœ… æ­£ç¡®
st.title("ç­–ç•¥å›æµ‹")
st.button("å¼€å§‹å›æµ‹")

# âŒ é”™è¯¯
st.title("Strategy Backtest")
st.button("Start Backtest")
```

### æœ¬åœ°åŒ–å‡½æ•°

```python
# investapp/locales/__init__.py

TRANSLATIONS = {
    "backtest.title": "ç­–ç•¥å›æµ‹",
    "backtest.start_button": "å¼€å§‹å›æµ‹",
    "backtest.status.running": "å›æµ‹è¿›è¡Œä¸­...",
}

def _(key: str) -> str:
    return TRANSLATIONS.get(key, key)
```

---

## ğŸ”Œ æ‰©å±•ç‚¹

### æ·»åŠ æ–°æ•°æ®æº

```python
# investlib-data/src/investlib_data/sources/new_source.py

class NewSourceClient:
    def fetch_daily_data(self, symbol, start_date, end_date):
        # å®ç°æ•°æ®è·å–é€»è¾‘
        return pd.DataFrame(...)

# æ³¨å†Œåˆ° MarketDataFetcher
fetcher.add_source('newsource', NewSourceClient())
```

### æ·»åŠ æ–°æŒ‡æ ‡

```python
# investlib-quant/src/investlib_quant/indicators/my_indicator.py

def calculate_my_indicator(df, period=14):
    # è®¡ç®—æŒ‡æ ‡
    return indicator_series
```

### æ·»åŠ æ–°å¯¼å‡ºæ ¼å¼

```python
# investlib-export/src/investlib_export/json_generator.py

class JSONGenerator:
    def generate(self, backtest_result):
        return json.dumps(backtest_result, indent=2)
```

---

## ğŸ› è°ƒè¯•æŠ€å·§

### Streamlit è°ƒè¯•

```python
# æ˜¾ç¤ºæ•°æ®æ¡†ä¾›è°ƒè¯•
st.write("Debug data:", df)

# æ˜¾ç¤ºå˜é‡
st.json({'var1': var1, 'var2': var2})

# ä½¿ç”¨ st.expander æŠ˜å è°ƒè¯•ä¿¡æ¯
with st.expander("è°ƒè¯•ä¿¡æ¯"):
    st.write(debug_data)
```

### æ€§èƒ½åˆ†æ

```python
import cProfile
import pstats

profiler = cProfile.Profile()
profiler.enable()

# ä½ çš„ä»£ç 
run_backtest()

profiler.disable()
stats = pstats.Stats(profiler)
stats.sort_stats('cumulative')
stats.print_stats(20)
```

---

## ğŸ“¦ å‘å¸ƒæµç¨‹

### ç‰ˆæœ¬å·è§„åˆ™

- **Major.Minor.Patch** (ä¾‹å¦‚ï¼š0.3.0)
- Major: ä¸å…¼å®¹æ›´æ–°
- Minor: æ–°åŠŸèƒ½
- Patch: Bugä¿®å¤

### å‘å¸ƒæ¸…å•

- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] æ›´æ–° CHANGELOG.md
- [ ] æ›´æ–°ç‰ˆæœ¬å·
- [ ] åˆ›å»º Git tag
- [ ] æ„å»ºæ–‡æ¡£
- [ ] å‘å¸ƒåˆ° PyPI (å¦‚éœ€è¦)

```bash
# æ‰“æ ‡ç­¾
git tag -a v0.3.0 -m "Release V0.3: Production-Ready Enhancement"
git push origin v0.3.0
```

---

## ğŸ¤ è´¡çŒ®æŒ‡å—

### ä»£ç è§„èŒƒ

- éµå¾ª PEP 8
- ä½¿ç”¨ç±»å‹æç¤º
- ç¼–å†™æ–‡æ¡£å­—ç¬¦ä¸²
- ä¸­æ–‡ä¼˜å…ˆåŸåˆ™

### Pull Request æµç¨‹

1. Fork ä»“åº“
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯: `git checkout -b feature/my-feature`
3. æäº¤æ›´æ”¹: `git commit -m "feat: add new indicator"`
4. æ¨é€åˆ†æ”¯: `git push origin feature/my-feature`
5. åˆ›å»º Pull Request

### Commit ä¿¡æ¯è§„èŒƒ

```
feat: æ–°åŠŸèƒ½
fix: Bugä¿®å¤
docs: æ–‡æ¡£æ›´æ–°
test: æµ‹è¯•ç›¸å…³
refactor: ä»£ç é‡æ„
perf: æ€§èƒ½ä¼˜åŒ–
chore: æ„å»º/å·¥å…·æ›´æ–°
```

---

## ğŸ“š å‚è€ƒèµ„æº

- **Streamlit æ–‡æ¡£**: https://docs.streamlit.io
- **Pandas æ–‡æ¡£**: https://pandas.pydata.org
- **SQLAlchemy æ–‡æ¡£**: https://docs.sqlalchemy.org
- **efinance æ–‡æ¡£**: https://github.com/cj-efinance/efinance
- **AkShare æ–‡æ¡£**: https://akshare.akfamily.xyz

---

**æœ€åæ›´æ–°**: 2025-10-24
**ç»´æŠ¤è€…**: MyInvest Team
